# DaCapo 开发手册

> 本文档旨在帮助开发者快速理解 DaCapo 项目的整体架构、核心代码逻辑和关键流程。
>
> _GitHub Copilot生成_

## 目录

- [1. 项目概述](#1-项目概述)
- [2. 技术架构](#2-技术架构)
- [3. 项目结构](#3-项目结构)
- [4. 核心模块详解](#4-核心模块详解)
- [5. 关键业务流程](#5-关键业务流程)

---

## 1. 项目概述

### 1.1 项目定位

**DaCapo** 是一个配置文件驱动的图形化脚本管理器，主要用于：

- 为复杂配置的命令行程序提供图形化界面
- 集中管理多个脚本/程序实例
- 支持定时任务调度和自动化执行
- 自动管理 Python 虚拟环境和依赖

### 1.2 核心特性

- ✅ **配置驱动**: 通过 JSON/YAML 配置文件生成 GUI
- ✅ **实例管理**: 一键管理和运行多个任务实例
- ✅ **远程仓库**: 自动从 Git 仓库拉取代码并创建界面
- ✅ **环境管理**: 自动管理 Python 虚拟环境和依赖
- ✅ **定时调度**: 使用 Cron 表达式设置定时执行计划
- ✅ **多语言支持**: 支持中文和英文界面
- ✅ **实时日志**: WebSocket 实时推送任务执行日志
- ✅ **自动更新**: 支持应用自动更新功能

### 1.3 应用场景

- 游戏自动化脚本管理（如游戏辅助脚本集中调度）
- 周期性任务执行（如数据爬取、定时备份）
- 多脚本协同管理（如工作流自动化）

---

## 2. 技术架构

### 2.1 技术栈

#### 前端

- **框架**: Vue 3 + TypeScript
- **UI 库**: Quasar Framework
- **构建工具**: Vite
- **状态管理**: Pinia
- **路由**: Vue Router
- **HTTP 客户端**: Axios
- **实时通信**: WebSocket

#### 后端

- **语言**: Go 1.23.3
- **桌面框架**: Wails v2.10.1
- **Web 框架**: Gin
- **数据库**: SQLite3 (go-sqlite3)
- **ORM**: GORM
- **WebSocket**: gorilla/websocket
- **定时任务**: robfig/cron
- **日志**: zap + lumberjack
- **自更新**: fynelabs/selfupdate

### 2.2 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                    Wails Desktop App                     │
├──────────────────┬──────────────────────────────────────┤
│   Frontend (Vue) │         Backend (Go)                 │
│                  │                                      │
│  ┌──────────┐    │  ┌─────────────────────────────┐   │
│  │  Pages   │◄───┼──┤   Wails Bindings (App)     │   │
│  │  (Views) │    │  └─────────────────────────────┘   │
│  └────┬─────┘    │                                      │
│       │          │  ┌─────────────────────────────┐   │
│  ┌────▼─────┐    │  │    Gin HTTP Server          │   │
│  │  Stores  │◄───┼──┤    (Port 48596)             │   │
│  │ (Pinia)  │    │  │  ┌──────────────────────┐   │   │
│  └────┬─────┘    │  │  │   Controllers        │   │   │
│       │          │  │  ├──────────────────────┤   │   │
│  ┌────▼─────┐    │  │  │   Services           │   │   │
│  │ Services │◄───┼──┤  │  - SchedulerService  │   │   │
│  │(HTTP/WS) │    │  │  │  - InstanceUpdater   │   │   │
│  └──────────┘    │  │  │  - WebSocketService  │   │   │
│                  │  │  └──────────────────────┘   │   │
│                  │  └─────────────────────────────┘   │
│                  │                                      │
│                  │  ┌─────────────────────────────┐   │
│                  │  │        Models               │   │
│                  │  │  - InstanceInfo             │   │
│                  │  │  - TaskManager              │   │
│                  │  │  - Scheduler                │   │
│                  │  └────────┬────────────────────┘   │
│                  │           │                         │
│                  │  ┌────────▼────────────────────┐   │
│                  │  │     SQLite Database         │   │
│                  │  │  - instances                │   │
│                  │  │  - templates                │   │
│                  │  │  - settings                 │   │
│                  │  └─────────────────────────────┘   │
└──────────────────┴──────────────────────────────────────┘
```

### 2.3 数据流转

```
用户操作 → 前端界面 → Wails Binding / HTTP API → Controller → Service → Model → Database
                                                           ↓
                                               WebSocket ← ← ←
                                                           ↓
                                               前端实时更新
```

---

## 3. 项目结构

### 3.1 目录结构

```
DaCapo/
├── backend/                 # 后端 Go 代码
│   ├── app/                # Wails 应用入口和生命周期管理
│   │   └── app.go         # App 结构体，处理启动、关闭等事件
│   ├── controller/         # 控制器层（HTTP 请求处理）
│   │   ├── app_updater_ctrl.go      # 应用更新控制器
│   │   ├── file_watcher_ctrl.go     # 文件监控控制器
│   │   ├── instance_ctrl.go         # 实例管理控制器
│   │   ├── instance_updater_ctrl.go # 实例更新控制器
│   │   ├── scheduler_ctrl.go        # 调度器控制器
│   │   ├── settings_ctrl.go         # 设置控制器
│   │   ├── template_ctrl.go         # 模板管理控制器
│   │   └── services.go              # 服务依赖注入
│   ├── model/              # 数据模型层
│   │   ├── db.go                    # 数据库初始化和连接
│   │   ├── instance_conf.go         # 实例配置模型
│   │   ├── instance_info.go         # 实例信息模型
│   │   ├── request.go               # 请求数据结构
│   │   ├── response.go              # 响应数据结构
│   │   ├── scheduler.go             # 调度器模型
│   │   ├── settings.go              # 设置模型
│   │   ├── template_conf.go         # 模板配置模型
│   │   └── template_info.go         # 模板信息模型
│   ├── router/             # 路由配置
│   │   └── router.go                # HTTP 路由设置
│   ├── service/            # 业务逻辑层
│   │   ├── instance.go              # 实例服务
│   │   ├── instance_updater.go      # 实例更新服务
│   │   ├── scheduler.go             # 调度器服务
│   │   ├── service_manager.go       # 服务管理器
│   │   └── websocket.go             # WebSocket 服务
│   ├── utils/              # 工具库
│   │   ├── close.go                 # 关机工具
│   │   ├── git.go                   # Git 操作工具
│   │   ├── logger.go                # 日志工具
│   │   ├── symlink.go               # 符号链接工具
│   │   ├── update.go                # 更新工具
│   │   ├── version.go               # 版本管理工具
│   │   └── ws_manager.go            # WebSocket 管理器
│   └── server.go           # 独立 HTTP 服务器入口
├── frontend/               # 前端 Vue 代码
│   ├── src/
│   │   ├── boot/          # Quasar 启动文件
│   │   │   ├── axios.ts           # Axios 配置
│   │   │   └── i18n.ts            # 国际化配置
│   │   ├── components/    # 可复用组件
│   │   │   ├── AppUpdateDialog.vue
│   │   │   ├── CardTitle.vue
│   │   │   ├── DirInput.vue
│   │   │   ├── FileInput.vue
│   │   │   ├── GroupCard.vue
│   │   │   ├── ItemLine.vue
│   │   │   ├── LogViewer.vue
│   │   │   └── TaskItem.vue
│   │   ├── css/           # 全局样式
│   │   ├── i18n/          # 国际化翻译文件
│   │   ├── pages/         # 页面组件
│   │   ├── router/        # 路由配置
│   │   ├── services/      # API 服务封装
│   │   ├── stores/        # Pinia 状态管理
│   │   └── utils/         # 前端工具函数
│   ├── index.html
│   └── package.json
├── build/                  # 构建相关文件
│   ├── bin/               # 构建输出目录
│   ├── windows/           # Windows 特定配置
│   └── darwin/            # macOS 特定配置
├── docs/                   # 文档
│   ├── 开发者指南.md
│   ├── 用户指南.md
│   └── 开发手册.md        # 本文档
├── envs/                   # Python 虚拟环境目录
├── instances/              # 实例配置文件存储
├── logs/                   # 日志文件目录
├── repos/                  # Git 仓库克隆目录
├── tools/                  # 工具程序（如 git.exe, uv.exe）
├── main.go                 # 主入口文件
├── wails.json             # Wails 配置文件
├── go.mod                 # Go 依赖管理
└── settings.yml           # 应用设置文件
```

### 3.2 核心文件说明

| 文件路径                              | 作用                                                   |
| ------------------------------------- | ------------------------------------------------------ |
| `main.go`                             | 程序入口，初始化日志、数据库、HTTP 服务器和 Wails 应用 |
| `backend/app/app.go`                  | Wails 应用生命周期管理，启动文件监控和定时任务         |
| `backend/router/router.go`            | HTTP 路由配置，WebSocket 升级处理                      |
| `backend/model/scheduler.go`          | 调度器单例，管理所有实例的任务队列                     |
| `backend/service/scheduler.go`        | 调度器业务逻辑，任务执行和状态管理                     |
| `backend/service/instance_updater.go` | 实例更新服务，处理 Git 拉取和环境管理                  |
| `backend/utils/git.go`                | Git 命令封装，支持自动下载 Git 工具                    |
| `frontend/src/pages/IndexPage.vue`    | 主界面页面                                             |
| `frontend/src/stores/`                | 状态管理，包括实例、模板、设置等                       |

---

## 4. 核心模块详解

### 4.1 Model 层 (数据模型)

#### 4.1.1 Scheduler (调度器)

**文件**: `backend/model/scheduler.go`

**核心数据结构**:

```go
// 任务状态常量
const (
    StatusPending  = "pending"   // 空闲等待
    StatusRunning  = "running"   // 正在执行
    StatusUpdating = "updating"  // 正在更新（拉取代码）
    StatusFailed   = "failed"    // 执行失败
)

// 任务队列
type TaskQueue struct {
    Running string   // 正在执行的任务名
    Waiting []string // 等待执行的任务列表
    Stopped []string // 已完成的任务列表
}

// 任务管理器（单个实例）
type TaskManager struct {
    InstanceName string       // 实例名称
    Status       string        // 实例状态
    Queue        TaskQueue     // 任务队列
    Cmd          *exec.Cmd     // 当前执行的命令进程
    ManualStop   bool          // 是否手动停止
}

// 调度器（全局单例）
type Scheduler struct {
    TaskManagers map[string]*TaskManager  // 所有实例的任务管理器
    IsRunning    bool                      // 调度器是否运行中
    CronExpr     string                    // Cron 表达式
    AutoClose    bool                      // 是否自动关机
    CloseFunc    func()                    // 关机回调函数
    mu           sync.Mutex                // 互斥锁
}
```

**关键方法**:

| 方法                       | 说明                                   |
| -------------------------- | -------------------------------------- |
| `GetScheduler()`           | 获取调度器单例，初始化时同步数据库状态 |
| `Start()` / `Stop()`       | 启动/停止调度器                        |
| `UpdateQueue(queues)`      | 批量更新多个实例的任务队列             |
| `CancelTask(instanceName)` | 取消指定实例的当前任务                 |
| `GetTaskManager(name)`     | 获取指定实例的任务管理器               |
| `SyncWithDatabase()`       | 从数据库同步实例状态到调度器           |

**设计要点**:

- **单例模式**: 全局只有一个 Scheduler 实例
- **状态同步**: 启动时从数据库加载所有实例的任务队列
- **线程安全**: 使用 mutex 保护队列更新操作

#### 4.1.2 InstanceInfo (实例信息)

**文件**: `backend/model/instance_info.go`

**核心数据结构**:

```go
// 任务信息（数据库表）
type TaskInfo struct {
    gorm.Model
    InstanceID uint         // 所属实例 ID（外键）
    Name       string       // 任务名称
    Active     *bool        // 是否启用
    Priority   uint         // 优先级
    Command    string       // 执行命令
    // ...Disabled 字段表示该配置项是否可编辑
}

// 实例信息（数据库表）
type InstanceInfo struct {
    gorm.Model
    Name             string     // 实例名称（唯一）
    TemplateName     string     // 模板名称
    Ready            bool       // 是否就绪
    Language         string     // 界面语言
    WorkDir          string     // 工作目录
    Background       bool       // 是否后台运行
    ConfigPath       string     // 配置文件路径
    LogPath          string     // 日志文件路径
    CronExpr         string     // 定时表达式
    RepoURL          string     // Git 仓库 URL
    LocalPath        string     // 本地路径
    Branch           string     // Git 分支
    AutoUpdate       bool       // 是否自动更新
    EnvName          string     // Python 虚拟环境名称
    DepsPath         string     // 依赖文件路径
    PythonVersion    string     // Python 版本
    Tasks            []TaskInfo // 任务列表（一对多）
}
```

**关键方法**:

| 方法                      | 说明                                 |
| ------------------------- | ------------------------------------ |
| `GetAllInstances()`       | 获取所有实例信息                     |
| `GetInstanceByName(name)` | 根据名称获取实例                     |
| `GetByName(name)`         | 获取实例信息（包括任务列表）         |
| `Create()`                | 创建新实例                           |
| `Update()`                | 更新实例信息                         |
| `Delete()`                | 删除实例                             |
| `GetTaskQueue()`          | 获取实例的任务队列（从配置文件解析） |
| `GetTaskByName(taskName)` | 根据名称获取任务信息                 |
| `GetConfigMap()`          | 解析配置文件为 Map                   |

**设计要点**:

- **配置文件驱动**: 配置项由模板定义，实例保存用户设置
- **任务关联**: 通过 GORM 关联查询任务列表
- **灵活配置**: Disabled 字段控制配置项是否可编辑

#### 4.1.3 TemplateInfo (模板信息)

**文件**: `backend/model/template_info.go`

**作用**: 存储从 Git 仓库解析的模板配置信息，用于创建实例时的默认值

**核心字段**:

- 与 InstanceInfo 类似，但不包含用户自定义的值
- 用于创建新实例时的初始化

#### 4.1.4 Settings (全局设置)

**文件**: `backend/model/settings.go`

**作用**: 管理应用级别的全局设置（存储在 `settings.yml`）

**核心字段**:

```go
type Settings struct {
    Language     string  // 界面语言
    Theme        string  // 主题
    AutoUpdate   bool    // 是否自动更新应用
    // ...
}
```

---

### 4.2 Service 层 (业务逻辑)

#### 4.2.1 SchedulerService (调度服务)

**文件**: `backend/service/scheduler.go`

**核心职责**: 管理任务的执行流程和状态转换

**关键方法**:

| 方法                                         | 说明                         |
| -------------------------------------------- | ---------------------------- |
| `UpdateInstanceStatus(instanceName, status)` | 更新实例状态并广播到前端     |
| `StartAll()`                                 | 启动所有实例的任务执行       |
| `StartOne(instanceName)`                     | 启动单个实例的任务执行       |
| `StopAll()`                                  | 停止所有正在运行的实例       |
| `RunCommand(tm, command, workDir)`           | 执行命令并处理输出           |
| `processOutput(pipe, instanceName, isError)` | 处理命令输出流，实时推送日志 |

**任务执行流程** (`StartAll`):

```
1. Scheduler.Start() → 状态变为 Running
2. 从数据库获取所有 Ready 的实例
3. 分类为前台任务和后台任务
   - 后台任务 (Background=true): 并发执行
   - 前台任务 (Background=false): 顺序执行
4. 后台任务: 启动多个 goroutine，每个执行一个实例
5. 前台任务: 按顺序执行，遇到 Updating 状态会跳过并重新排队
6. 等待所有任务完成
7. Scheduler.Stop() → 状态变为 Pending
8. 触发 CloseFunc（可能关机）
```

**任务状态流转** (单个实例):

```
Pending → (StartOne) → Running → (执行) → Pending/Failed
Pending → (UpdateRepo) → Updating → (更新) → Pending/Failed

状态说明:
- Pending: 待执行
- Running: 执行中
- Updating: 更新中 (不能被启动运行)
- Failed: 执行/更新失败
```

**命令执行特性**:

- 捕获 stdout 和 stderr 实时推送到前端
- 支持 GBK/UTF-8 编码自动检测和转换
- 设置环境变量强制彩色输出
- 支持 Python 虚拟环境自动识别

#### 4.2.2 InstanceUpdaterService (实例更新服务)

**文件**: `backend/service/instance_updater.go`

**核心职责**: 处理实例的代码更新和环境管理

**关键方法**:

| 方法                                             | 说明                     |
| ------------------------------------------------ | ------------------------ |
| `UpdateRepo(instanceName)`                       | 更新仓库代码、环境和配置 |
| `createEnv(tm, envPath, pythonVersion)`          | 创建 Python 虚拟环境     |
| `installDeps(tm, envPath, depsPath, lastUpdate)` | 安装 Python 依赖         |
| `CheckAndUpdate(istName)`                        | 检查并自动更新实例       |
| `RunUpdateTask(instances)`                       | 批量更新实例             |

**更新流程** (`UpdateRepo`):

```
1. 检查实例运行状态，如果正在运行则拒绝更新
2. 设置实例状态为 Updating
3. 移除配置文件符号链接
4. 执行 git pull 拉取最新代码
5. 重新创建符号链接
6. 如果配置了虚拟环境:
   a. 创建/更新 Python 虚拟环境 (使用 uv)
   b. 安装/更新依赖 (requirements.txt)
   c. 更新 EnvLastUpdate 时间戳
7. 检查模板文件是否更新:
   - 如果更新，重新解析配置并更新数据库
8. 恢复实例状态为 Pending/Failed
```

**Python 环境管理**:

- 使用 `uv` 工具管理虚拟环境（比 pip 更快）
- 支持指定 Python 版本
- 依赖文件修改时间戳对比，避免重复安装

#### 4.2.3 WebSocketService (WebSocket 服务)

**文件**: `backend/service/websocket.go`

**核心职责**: 实时推送数据到前端

**关键方法**:

| 方法                                   | 说明                |
| -------------------------------------- | ------------------- |
| `HandleConnection(conn, handler)`      | 处理 WebSocket 连接 |
| `BroadcastState(instanceName, status)` | 广播实例状态变化    |
| `BroadcastQueue(instanceName)`         | 广播任务队列更新    |
| `BroadcastLog(instanceName, log)`      | 广播实时日志        |
| `SendQueue(conn)`                      | 发送初始任务队列    |
| `SendState(conn)`                      | 发送初始状态        |

**消息类型**:

| Type               | 说明            | 数据格式                                             |
| ------------------ | --------------- | ---------------------------------------------------- |
| `state`            | 实例/调度器状态 | `{instanceName, status}`                             |
| `queue`            | 任务队列        | `{instanceName, queue: {running, waiting, stopped}}` |
| `log`              | 实时日志        | `{instanceName, message}`                            |
| `update_available` | 应用更新可用    | `{version, releaseNotes}`                            |

**连接管理**:

- 使用 `WSManager` 维护所有活跃连接
- 新连接建立时发送初始状态和队列
- 广播消息时遍历所有连接

#### 4.2.4 InstanceService (实例服务)

**文件**: `backend/service/instance.go`

**核心职责**: 实例的创建、导入和配置管理

**关键方法**:

| 方法                                 | 说明            |
| ------------------------------------ | --------------- |
| `CreateInstance(name, tplName)`      | 创建新实例      |
| `ImportTemplate(url, branch)`        | 从 Git 导入模板 |
| `GetInstanceConfig(name)`            | 获取实例配置    |
| `UpdateInstanceConfig(name, config)` | 更新实例配置    |

---

### 4.3 Controller 层 (HTTP 请求处理)

#### 4.3.1 路由配置

**文件**: `backend/router/router.go`

**HTTP 服务器配置**:

- 端口: `48596`
- 框架: Gin
- 跨域: 允许 `wails.localhost` 和 `localhost:33204`
- 日志: 自定义格式，输出到文件和控制台

**路由表**:

| 路径                              | 方法      | Controller              | 说明                |
| --------------------------------- | --------- | ----------------------- | ------------------- |
| `/api/instance`                   | POST      | `CreateIstFromLocal`    | 从本地目录创建实例  |
| `/api/instance/template`          | POST      | `CreateIstFromTemplate` | 从模板创建实例      |
| `/api/instance/remote`            | POST      | `CreateIstFromRemote`   | 从远程 Git 创建实例 |
| `/api/instance`                   | GET       | `GetAllInstances`       | 获取所有实例        |
| `/api/instance/:name`             | GET       | `GetInstance`           | 获取单个实例        |
| `/api/instance/:name`             | PATCH     | `UpdateInstance`        | 更新实例配置        |
| `/api/instance/:name`             | DELETE    | `DeleteInstance`        | 删除实例            |
| `/api/template`                   | GET       | `GetTemplate`           | 获取所有模板        |
| `/api/template/:name`             | DELETE    | `DeleteTemplate`        | 删除模板            |
| `/api/scheduler`                  | POST      | `UpdateScheduler`       | 更新调度器状态      |
| `/api/scheduler/task-queue`       | POST      | `UpdateTaskQueue`       | 更新任务队列        |
| `/api/scheduler/task-queue/:name` | GET       | `GetTaskQueue`          | 获取任务队列        |
| `/api/settings`                   | GET       | `GetSettings`           | 获取设置            |
| `/api/settings`                   | PATCH     | `UpdateSettings`        | 更新设置            |
| `/api/update/instance/:name`      | POST      | `UpdateRepo`            | 更新实例仓库        |
| `/api/update/check`               | POST      | `CheckUpdate`           | 检查应用更新        |
| `/ws`                             | WebSocket | -                       | WebSocket 连接      |

#### 4.3.2 关键 Controller

**InstanceController** (`backend/controller/instance_ctrl.go`):

- 处理实例的 CRUD 操作
- 创建实例时调用 `InstanceService`
- 返回统一格式的 JSON 响应

**SchedulerController** (`backend/controller/scheduler_ctrl.go`):

- 处理调度器的启动/停止
- 更新任务队列
- 调用 `SchedulerService` 执行任务

**InstanceUpdaterController** (`backend/controller/instance_updater_ctrl.go`):

- 处理实例更新请求
- 调用 `InstanceUpdaterService.UpdateRepo()`
- 返回更新结果

#### 4.3.3 服务依赖注入

**文件**: `backend/controller/services.go`

```go
var (
    schedulerService        *service.SchedulerService
    instanceUpdaterService  *service.InstanceUpdaterService
    wsService               *service.WebSocketService
)

func init() {
    // 初始化服务实例，建立依赖关系
    wsService = &service.WebSocketService{}
    schedulerService = &service.SchedulerService{}
    instanceUpdaterService = &service.InstanceUpdaterService{}

    // 注入依赖
    service.InitServices(schedulerService, instanceUpdaterService, wsService)
}
```

**设计模式**: 依赖注入，方便测试和扩展

---

### 4.4 Utils 工具模块

#### 4.4.1 Git 工具

**文件**: `backend/utils/git.go`

**核心功能**: Git 命令封装，支持自动下载 Git 工具

**关键函数**:

| 函数                              | 说明                    |
| --------------------------------- | ----------------------- |
| `GitClone(url, localDir, branch)` | 克隆仓库（带子模块）    |
| `GitCheckout(repoPath, branch)`   | 切换分支                |
| `GitPull(repoPath)`               | 拉取最新代码            |
| `getGitExecutable()`              | 获取 Git 可执行文件路径 |
| `downloadGit()`                   | 自动下载 Git 工具       |

**Git 查找逻辑**:

```
1. 尝试使用系统 git 命令
2. 如果失败，尝试使用 tools/git/cmd/git.exe
3. 如果都没有，根据用户地区下载 Git:
   - 中国: 从 Gitee 下载
   - 其他: 从 GitHub 下载
4. 解压到 tools/git 目录
5. 返回 git.exe 路径
```

**Pull 策略**:

- 无冲突: 正常合并，保留本地和远程修改
- 有冲突: `reset --hard` 到远程分支，放弃冲突的本地修改
- 未跟踪文件: 保留（不会被 reset 影响）

#### 4.4.2 日志工具

**文件**: `backend/utils/logger.go`

**功能**: 基于 zap 的日志系统，支持文件轮转

**配置**:

- 日志目录: `logs/`
- 文件名: `app.log`
- 轮转策略: 单文件最大 10MB，保留 30 个备份，最多 30 天

**日志级别**:

```go
Logger.Debug("调试信息")
Logger.Info("普通信息")
Logger.Warn("警告信息")
Logger.Error("错误信息")
Logger.Fatal("致命错误")
```

#### 4.4.3 符号链接工具

**文件**: `backend/utils/symlink.go`

**功能**: 管理配置文件的符号链接

**关键函数**:

| 函数                      | 说明               |
| ------------------------- | ------------------ |
| `CheckLink(target, link)` | 检查并创建符号链接 |
| `RemoveLink(link)`        | 移除符号链接       |

**用途**: 将仓库中的配置文件链接到 `instances/` 目录，方便管理

#### 4.4.4 更新工具

**文件**: `backend/utils/update.go`

**功能**: 应用自动更新

**关键函数**:

| 函数                         | 说明               |
| ---------------------------- | ------------------ |
| `CheckForUpdates()`          | 检查是否有新版本   |
| `DownloadAndInstallUpdate()` | 下载并安装更新     |
| `getCountry()`               | 获取用户所在国家   |
| `getUrls()`                  | 根据国家选择下载源 |

**更新流程**:

```
1. 从远程获取 version.txt
2. 对比当前版本号
3. 如果有新版本，下载 .exe 文件
4. 验证签名（.ed25519）
5. 替换当前可执行文件
6. 重启应用
```

#### 4.4.5 WebSocket 管理器

**文件**: `backend/utils/ws_manager.go`

**功能**: 管理所有 WebSocket 连接

**核心结构**:

```go
type WSManager struct {
    clients map[*websocket.Conn]bool
    mu      sync.RWMutex
}
```

**关键方法**:

| 方法                      | 说明               |
| ------------------------- | ------------------ |
| `RegisterClient(conn)`    | 注册新连接         |
| `RemoveClient(conn)`      | 移除连接           |
| `BroadcastJSON(message)`  | 向所有连接广播消息 |
| `SendJSON(conn, message)` | 向单个连接发送消息 |

#### 4.4.6 关机工具

**文件**: `backend/utils/close.go`

**功能**: 跨平台关机/休眠

**关键函数**:

| 函数         | 说明 |
| ------------ | ---- |
| `Shutdown()` | 关机 |
| `Sleep()`    | 休眠 |

**实现**:

- Windows: 使用 `shutdown.exe` 命令
- Linux/macOS: 使用 `systemctl` 或 `pmset` 命令

---

### 4.5 前端架构

#### 4.5.1 技术栈

- **框架**: Vue 3 (Composition API + TypeScript)
- **UI 库**: Quasar Framework
- **状态管理**: Pinia
- **HTTP**: Axios
- **WebSocket**: 原生 WebSocket API
- **构建**: Vite

#### 4.5.2 目录结构

```
frontend/src/
├── boot/               # Quasar 启动文件
│   ├── axios.ts       # Axios 配置（baseURL, 拦截器）
│   └── i18n.ts        # i18n 配置
├── components/         # 可复用组件
│   ├── AppUpdateDialog.vue    # 应用更新对话框
│   ├── CardTitle.vue          # 卡片标题
│   ├── DirInput.vue           # 目录选择输入框
│   ├── FileInput.vue          # 文件选择输入框
│   ├── GroupCard.vue          # 分组卡片
│   ├── ItemLine.vue           # 配置项行
│   ├── LogViewer.vue          # 日志查看器
│   └── TaskItem.vue           # 任务项
├── css/                # 全局样式
│   ├── app.scss       # 应用样式
│   └── quasar.variables.scss  # Quasar 变量
├── i18n/               # 国际化
│   ├── index.ts       # i18n 配置
│   ├── en-US/         # 英文翻译
│   └── zh-CN/         # 中文翻译
├── pages/              # 页面组件
│   ├── MainPage.vue           # 主页（包含左侧导航）
│   ├── HomePage.vue           # 首页（实例列表）
│   ├── WelcomePage.vue        # 欢迎页（无实例时）
│   ├── InstancePage.vue       # 实例详情页（动态路由）
│   ├── GeneralPage.vue        # 通用设置页
│   ├── UpdatePage.vue         # 更新设置页
│   ├── CustomPage.vue         # 自定义配置页
│   └── SettingsPage.vue       # 应用设置页
├── router/             # 路由
│   ├── index.ts       # 路由实例
│   └── routes.ts      # 路由配置
├── services/           # API 服务
│   ├── http.ts        # HTTP 请求封装
│   └── websocket.ts   # WebSocket 封装
├── stores/             # Pinia 状态管理
│   ├── index.ts       # Store 导出
│   └── global-store.ts # 全局状态
└── utils/              # 工具函数
    └── helpers.ts      # 辅助函数
```

#### 4.5.3 状态管理 (Pinia)

**文件**: `frontend/src/stores/global-store.ts`

**全局状态**:

```typescript
interface GlobalState {
  // 实例相关
  instances: InstanceInfo[]; // 所有实例
  currentInstance: InstanceInfo | null; // 当前实例

  // 模板相关
  templates: TemplateInfo[]; // 所有模板

  // 调度器相关
  schedulerState: string; // 调度器状态
  taskQueues: Record<string, TaskQueue>; // 任务队列

  // WebSocket
  wsConnected: boolean; // WebSocket 连接状态

  // 设置
  settings: Settings; // 应用设置
}
```

**关键 Actions**:

| Action                         | 说明                    |
| ------------------------------ | ----------------------- |
| `fetchInstances()`             | 从后端获取所有实例      |
| `fetchTemplates()`             | 获取所有模板            |
| `createInstance(data)`         | 创建新实例              |
| `updateInstance(name, data)`   | 更新实例配置            |
| `deleteInstance(name)`         | 删除实例                |
| `startScheduler(name?)`        | 启动调度器（单个/全部） |
| `stopScheduler(name?)`         | 停止调度器（单个/全部） |
| `updateTaskQueue(name, queue)` | 更新任务队列            |
| `connectWebSocket()`           | 建立 WebSocket 连接     |

#### 4.5.4 WebSocket 通信

**文件**: `frontend/src/services/websocket.ts`

**连接管理**:

```typescript
class WebSocketService {
  private ws: WebSocket | null;
  private reconnectTimer: number;

  connect(url: string) {
    // 建立连接
    this.ws = new WebSocket(url);

    // 监听消息
    this.ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      this.handleMessage(data);
    };

    // 断线重连
    this.ws.onclose = () => {
      setTimeout(() => this.connect(url), 3000);
    };
  }

  handleMessage(data: any) {
    switch (data.type) {
      case "state":
        // 更新实例状态
        store.updateInstanceState(data.instanceName, data.status);
        break;
      case "queue":
        // 更新任务队列
        store.updateTaskQueue(data.instanceName, data.queue);
        break;
      case "log":
        // 添加日志
        store.appendLog(data.instanceName, data.message);
        break;
    }
  }
}
```

**消息类型处理**:

- `state`: 更新实例/调度器状态，触发界面更新
- `queue`: 更新任务队列，刷新任务列表
- `log`: 追加日志到日志查看器

#### 4.5.5 页面组件

**MainPage** (`pages/MainPage.vue`):

- 左侧抽屉导航（实例列表）
- 右侧内容区域（动态路由视图）
- 顶部工具栏（启动/停止按钮）

**HomePage** (`pages/HomePage.vue`):

- 显示所有实例卡片
- 快速操作按钮（启动、更新、删除）
- 无实例时跳转到 WelcomePage

**InstancePage** (`pages/InstancePage.vue`):

- 动态路由: `/instance/:name/:tab`
- Tab 页签: General, Update, Custom
- 配置表单（根据模板动态生成）
- 实时日志查看器

**SettingsPage** (`pages/SettingsPage.vue`):

- 应用设置（语言、主题、自动更新）
- 关机选项设置

---

## 5. 关键业务流程

### 5.1 应用启动流程

```
1. main.go 启动
   ├─ InitLogger() - 初始化日志系统
   ├─ InitDB() - 初始化 SQLite 数据库
   ├─ SetupRouter() - 配置 Gin 路由
   ├─ go r.Run(":48596") - 启动 HTTP 服务器（后台）
   └─ wails.Run() - 启动 Wails 桌面应用

2. Wails App.Startup()
   ├─ 检查并创建配置文件符号链接
   ├─ 启动文件监控器（监听实例配置变化）
   ├─ 加载全局设置
   ├─ 为每个实例设置 Cron 定时任务
   └─ 删除旧版本可执行文件（如果存在）

3. 前端启动
   ├─ Quasar 初始化
   ├─ Axios 配置（baseURL: http://localhost:48596）
   ├─ i18n 加载
   ├─ Pinia Store 初始化
   ├─ fetchInstances() - 获取所有实例
   ├─ fetchTemplates() - 获取所有模板
   └─ connectWebSocket() - 建立 WebSocket 连接
```

### 5.2 创建实例流程

#### 5.2.1 从远程 Git 创建

```
1. 用户在前端填写表单
   - Git URL: https://github.com/user/repo
   - Branch: main (可选)
   - Instance Name: my-instance

2. 前端发送 POST /api/instance/remote
   {
     "repo_url": "https://github.com/user/repo",
     "branch": "main",
     "instance_name": "my-instance"
   }

3. 后端处理 (InstanceService.ImportTemplate)
   ├─ GitClone(url, "repos/", branch) - 克隆仓库到 repos/ 目录
   │   └─ 查找 Git 可执行文件（系统/bundled/自动下载）
   ├─ 解析 template/template.yaml - 读取模板配置
   ├─ 保存到数据库 (TemplateInfo 表)
   ├─ 创建实例 (InstanceInfo 表)
   │   ├─ 设置默认值（从模板）
   │   ├─ 创建符号链接: instances/my-instance.json -> repos/.../config.json
   │   └─ 解析任务列表并保存 (TaskInfo 表)
   ├─ 创建 TaskManager 并添加到 Scheduler
   └─ 返回实例信息给前端

4. 前端更新
   ├─ Store.instances.push(newInstance)
   ├─ 跳转到实例详情页
   └─ WebSocket 推送初始状态
```

#### 5.2.2 从模板创建

```
1. 用户选择已有模板
2. 前端发送 POST /api/instance/template
3. 后端直接从 TemplateInfo 复制配置创建实例
4. 无需再次克隆仓库
```

### 5.3 任务执行流程

#### 5.3.1 启动单个实例

```
1. 用户点击"启动"按钮（HomePage 或 InstancePage）

2. 前端发送 POST /api/scheduler
   {
     "action_type": "start",
     "instance_name": "my-instance"
   }

3. 后端 SchedulerController
   ├─ SchedulerService.UpdateSchedulerState("start", "my-instance")
   └─ go SchedulerService.StartOne("my-instance")

4. SchedulerService.StartOne()
   ├─ 更新状态: StatusPending → StatusRunning
   ├─ WebSocket 广播状态变化
   ├─ 循环执行任务队列
   │   ├─ taskName = tm.SwitchRun() - 从 Waiting 取出第一个任务
   │   ├─ WebSocket 广播队列更新
   │   ├─ 获取任务信息 (TaskInfo)
   │   ├─ 构建命令
   │   │   └─ 如果是 "py xxx.py"，替换为虚拟环境的 python.exe
   │   ├─ RunCommand(tm, cmd, workDir)
   │   │   ├─ 创建 exec.Command
   │   │   ├─ 设置环境变量（PYTHONUNBUFFERED, FORCE_COLOR）
   │   │   ├─ 创建 stdout/stderr pipe
   │   │   ├─ cmd.Start() - 启动进程
   │   │   ├─ processOutput() - 读取输出并实时推送
   │   │   │   ├─ 检测编码（UTF-8/GBK）
   │   │   │   └─ WebSocket.BroadcastLog()
   │   │   └─ cmd.Wait() - 等待进程结束
   │   └─ 检查错误
   │       ├─ 成功: 继续下一个任务
   │       ├─ 失败: 停止并设置 StatusFailed
   │       └─ 手动停止: 返回
   └─ 所有任务完成: StatusRunning → StatusPending

5. 前端实时更新
   ├─ 监听 WebSocket 消息
   ├─ type="state" → 更新实例状态（颜色、图标）
   ├─ type="queue" → 更新任务列表（Running/Waiting/Stopped）
   └─ type="log" → 追加日志到 LogViewer
```

#### 5.3.2 启动全部实例

```
1. 用户点击"全部启动"按钮

2. SchedulerService.StartAll()
   ├─ Scheduler.Start() - 设置 IsRunning=true
   ├─ WebSocket 广播全局状态 → Running
   ├─ 获取所有 Ready 的实例
   ├─ 分类: Background vs Foreground
   │   ├─ Background: 并发执行（多个 goroutine）
   │   └─ Foreground: 顺序执行（等待上一个完成）
   ├─ runBackgroundTasks(backgroundList)
   │   └─ 为每个实例启动 goroutine
   │       └─ runWithCheck() → StartOne()
   ├─ runForegroundTasks(foregroundList)
   │   └─ 遍历列表，逐个执行
   │       ├─ 跳过 StatusUpdating 的实例（重新排队）
   │       └─ StartOne()
   └─ 等待所有任务完成
       ├─ Scheduler.Stop()
       ├─ TriggerCloseFunc() - 可能关机
       └─ WebSocket 广播全局状态 → Pending
```

### 5.4 实例更新流程

```
1. 用户点击"更新"按钮或自动触发

2. 前端发送 POST /api/update/instance/:name

3. InstanceUpdaterService.UpdateRepo()
   ├─ 设置状态: StatusPending → StatusUpdating
   ├─ WebSocket 广播状态
   ├─ 移除配置文件符号链接
   ├─ GitPull(localPath) - 拉取最新代码
   │   ├─ git fetch origin
   │   ├─ git pull origin
   │   ├─ 如果有冲突:
   │   │   ├─ git merge --abort
   │   │   └─ git reset --hard @{u}
   │   └─ 返回命令日志
   ├─ 重新创建符号链接
   ├─ 如果配置了虚拟环境:
   │   ├─ createEnv() - 创建/检查虚拟环境
   │   │   └─ uv venv --python 3.13 envs/my-env
   │   ├─ installDeps() - 安装依赖
   │   │   ├─ 对比 requirements.txt 修改时间
   │   │   └─ uv pip install -r requirements.txt
   │   └─ 更新 EnvLastUpdate 时间戳
   ├─ 检查模板文件是否更新
   │   ├─ 对比 LayoutLastUpdate 和文件修改时间
   │   ├─ 如果更新: 重新解析 template.yaml
   │   └─ 更新数据库中的实例配置
   └─ 恢复状态: StatusUpdating → Pending/Failed

4. 前端更新
   ├─ 实例状态图标变化
   └─ 如果失败，显示错误信息
```

### 5.5 配置文件系统

#### 5.5.1 模板配置 (template.yaml)

```yaml
# 模板元信息
name: "my-template"
version: "1.0.0"
author: "username"

# 配置项定义
config:
  general:
    - name: "work_dir"
      type: "dir"
      label: "工作目录"
      default: "./"
      disabled: false
    - name: "language"
      type: "dropdown"
      label: "语言"
      options: ["zh-CN", "en-US"]
      default: "zh-CN"

  custom:
    - name: "api_key"
      type: "input"
      label: "API Key"
      default: ""

# 任务定义
tasks:
  - name: "task1"
    command: "py script.py"
    priority: 1
    active: true
  - name: "task2"
    command: "py another.py"
    priority: 2
```

#### 5.5.2 实例配置 (instances/xxx.json)

```json
{
  "work_dir": "./repos/my-repo",
  "language": "zh-CN",
  "api_key": "your-api-key",
  "tasks": [
    {
      "name": "task1",
      "active": true,
      "priority": 1
    }
  ]
}
```

#### 5.5.3 配置流转

```
1. template.yaml 定义配置结构
   └─ 后端解析为 TemplateInfo

2. 用户在前端修改配置
   └─ 保存到 InstanceInfo 数据库

3. 符号链接连接到仓库
   instances/xxx.json → repos/my-repo/config.json

4. 脚本读取 config.json 获取用户配置
```

### 5.6 WebSocket 实时通信

#### 5.6.1 连接建立

```
前端: new WebSocket("ws://localhost:48596/ws")
后端: HandleConnection() - 注册到 WSManager
```

#### 5.6.2 消息流向

```
后端事件 → WebSocketService.Broadcast*() → WSManager.BroadcastJSON()
                                           ↓
                                    遍历所有连接
                                           ↓
                                    conn.WriteJSON()
                                           ↓
                                    前端 ws.onmessage
                                           ↓
                                    更新 Pinia Store
                                           ↓
                                    Vue 响应式更新界面
```

#### 5.6.3 断线重连

```
前端检测 ws.onclose → 3 秒后重新连接 → 重新获取初始状态
```
