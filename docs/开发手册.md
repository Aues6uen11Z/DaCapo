# DaCapo å¼€å‘æ‰‹å†Œ

> æœ¬æ–‡æ¡£æ—¨åœ¨å¸®åŠ©å¼€å‘è€…å¿«é€Ÿç†è§£ DaCapo é¡¹ç›®çš„æ•´ä½“æ¶æ„ã€æ ¸å¿ƒä»£ç é€»è¾‘å’Œå…³é”®æµç¨‹ã€‚
>
> _GitHub Copilot ç”Ÿæˆ_

## ç›®å½•

- [1. é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
- [2. æŠ€æœ¯æ¶æ„](#2-æŠ€æœ¯æ¶æ„)
- [3. é¡¹ç›®ç»“æ„](#3-é¡¹ç›®ç»“æ„)
- [4. æ ¸å¿ƒæ¨¡å—è¯¦è§£](#4-æ ¸å¿ƒæ¨¡å—è¯¦è§£)
- [5. å…³é”®ä¸šåŠ¡æµç¨‹](#5-å…³é”®ä¸šåŠ¡æµç¨‹)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

**DaCapo** æ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶é©±åŠ¨çš„å›¾å½¢åŒ–è„šæœ¬ç®¡ç†å™¨ï¼Œä¸»è¦ç”¨äºï¼š

- ä¸ºå¤æ‚é…ç½®çš„å‘½ä»¤è¡Œç¨‹åºæä¾›å›¾å½¢åŒ–ç•Œé¢
- é›†ä¸­ç®¡ç†å¤šä¸ªè„šæœ¬/ç¨‹åºå®ä¾‹
- æ”¯æŒå®šæ—¶ä»»åŠ¡è°ƒåº¦å’Œè‡ªåŠ¨åŒ–æ‰§è¡Œ
- è‡ªåŠ¨ç®¡ç† Python è™šæ‹Ÿç¯å¢ƒå’Œä¾èµ–

### 1.2 æ ¸å¿ƒç‰¹æ€§

- âœ… **é…ç½®é©±åŠ¨**: é€šè¿‡ JSON/YAML é…ç½®æ–‡ä»¶ç”Ÿæˆ GUI
- âœ… **å®ä¾‹ç®¡ç†**: ä¸€é”®ç®¡ç†å’Œè¿è¡Œå¤šä¸ªä»»åŠ¡å®ä¾‹
- âœ… **è¿œç¨‹ä»“åº“**: è‡ªåŠ¨ä» Git ä»“åº“æ‹‰å–ä»£ç å¹¶åˆ›å»ºç•Œé¢
- âœ… **ç¯å¢ƒç®¡ç†**: è‡ªåŠ¨ç®¡ç† Python è™šæ‹Ÿç¯å¢ƒå’Œä¾èµ–
- âœ… **å®šæ—¶è°ƒåº¦**: ä½¿ç”¨ Cron è¡¨è¾¾å¼è®¾ç½®å®šæ—¶æ‰§è¡Œè®¡åˆ’
- âœ… **å¤šè¯­è¨€æ”¯æŒ**: æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ç•Œé¢
- âœ… **å®æ—¶æ—¥å¿—**: WebSocket å®æ—¶æ¨é€ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
- âœ… **è‡ªåŠ¨æ›´æ–°**: æ”¯æŒåº”ç”¨è‡ªåŠ¨æ›´æ–°åŠŸèƒ½

### 1.3 åº”ç”¨åœºæ™¯

- æ¸¸æˆè‡ªåŠ¨åŒ–è„šæœ¬ç®¡ç†ï¼ˆå¦‚æ¸¸æˆè¾…åŠ©è„šæœ¬é›†ä¸­è°ƒåº¦ï¼‰
- å‘¨æœŸæ€§ä»»åŠ¡æ‰§è¡Œï¼ˆå¦‚æ•°æ®çˆ¬å–ã€å®šæ—¶å¤‡ä»½ï¼‰
- å¤šè„šæœ¬ååŒç®¡ç†ï¼ˆå¦‚å·¥ä½œæµè‡ªåŠ¨åŒ–ï¼‰

---

## 2. æŠ€æœ¯æ¶æ„

### 2.1 æŠ€æœ¯æ ˆ

#### å‰ç«¯

- **æ¡†æ¶**: Vue 3 + TypeScript
- **UI åº“**: Quasar Framework
- **æ„å»ºå·¥å…·**: Vite
- **çŠ¶æ€ç®¡ç†**: Pinia
- **è·¯ç”±**: Vue Router
- **HTTP å®¢æˆ·ç«¯**: Axios
- **å®æ—¶é€šä¿¡**: WebSocket

#### åç«¯

- **è¯­è¨€**: Go 1.23.3
- **æ¡Œé¢æ¡†æ¶**: Wails v2.10.1
- **Web æ¡†æ¶**: Gin
- **æ•°æ®åº“**: SQLite3 (go-sqlite3)
- **ORM**: GORM
- **WebSocket**: gorilla/websocket
- **å®šæ—¶ä»»åŠ¡**: robfig/cron
- **æ—¥å¿—**: zap + lumberjack
- **è‡ªæ›´æ–°**: fynelabs/selfupdate

### 2.2 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Wails Desktop App                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Frontend (Vue) â”‚         Backend (Go)                 â”‚
â”‚                  â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Pages   â”‚â—„â”€â”€â”€â”¼â”€â”€â”¤   Wails Bindings (App)     â”‚   â”‚
â”‚  â”‚  (Views) â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”‚                                      â”‚
â”‚       â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”‚  â”‚    Gin HTTP Server          â”‚   â”‚
â”‚  â”‚  Stores  â”‚â—„â”€â”€â”€â”¼â”€â”€â”¤    (Port 48596)             â”‚   â”‚
â”‚  â”‚ (Pinia)  â”‚    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚   Controllers        â”‚   â”‚   â”‚
â”‚       â”‚          â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”‚   ServiceManager     â”‚   â”‚   â”‚
â”‚  â”‚ Services â”‚â—„â”€â”€â”€â”¼â”€â”€â”¤  â”‚  (Dependency Inject) â”‚   â”‚   â”‚
â”‚  â”‚(HTTP/WS) â”‚    â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚   Services           â”‚   â”‚   â”‚
â”‚                  â”‚  â”‚  â”‚  - SchedulerService  â”‚   â”‚   â”‚
â”‚                  â”‚  â”‚  â”‚  - InstanceService   â”‚   â”‚   â”‚
â”‚                  â”‚  â”‚  â”‚  - InstanceUpdater   â”‚   â”‚   â”‚
â”‚                  â”‚  â”‚  â”‚  - WebSocketService  â”‚   â”‚   â”‚
â”‚                  â”‚  â”‚  â”‚  - NotificationSvc   â”‚   â”‚   â”‚
â”‚                  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚                  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                  â”‚                                      â”‚
â”‚                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                  â”‚  â”‚        Models               â”‚   â”‚
â”‚                  â”‚  â”‚  - InstanceInfo             â”‚   â”‚
â”‚                  â”‚  â”‚  - TaskManager              â”‚   â”‚
â”‚                  â”‚  â”‚  - Scheduler                â”‚   â”‚
â”‚                  â”‚  â”‚  - SchedulerResult          â”‚   â”‚
â”‚                  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                  â”‚           â”‚                         â”‚
â”‚                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                  â”‚  â”‚     SQLite Database         â”‚   â”‚
â”‚                  â”‚  â”‚  - instances                â”‚   â”‚
â”‚                  â”‚  â”‚  - templates                â”‚   â”‚
â”‚                  â”‚  â”‚  - settings                 â”‚   â”‚
â”‚                  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ•°æ®æµè½¬

```
ç”¨æˆ·æ“ä½œ â†’ å‰ç«¯ç•Œé¢ â†’ Wails Binding / HTTP API â†’ Controller â†’ Service â†’ Model â†’ Database
                                                           â†“
                                               WebSocket â† â† â†
                                                           â†“
                                               å‰ç«¯å®æ—¶æ›´æ–°
```

---

## 3. é¡¹ç›®ç»“æ„

### 3.1 ç›®å½•ç»“æ„

```
DaCapo/
â”œâ”€â”€ backend/                 # åç«¯ Go ä»£ç 
â”‚   â”œâ”€â”€ app/                # Wails åº”ç”¨å…¥å£å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â”‚   â””â”€â”€ app.go         # App ç»“æ„ä½“ï¼Œå¤„ç†å¯åŠ¨ã€å…³é—­ç­‰äº‹ä»¶
â”‚   â”œâ”€â”€ controller/         # æ§åˆ¶å™¨å±‚ï¼ˆHTTP è¯·æ±‚å¤„ç†ï¼‰
â”‚   â”‚   â”œâ”€â”€ app_updater_ctrl.go      # åº”ç”¨æ›´æ–°æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ file_watcher_ctrl.go     # æ–‡ä»¶ç›‘æ§æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ instance_ctrl.go         # å®ä¾‹ç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ instance_updater_ctrl.go # å®ä¾‹æ›´æ–°æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ scheduler_ctrl.go        # è°ƒåº¦å™¨æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ settings_ctrl.go         # è®¾ç½®æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ template_ctrl.go         # æ¨¡æ¿ç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ services.go              # æœåŠ¡ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ model/              # æ•°æ®æ¨¡å‹å±‚
â”‚   â”‚   â”œâ”€â”€ db.go                    # æ•°æ®åº“åˆå§‹åŒ–å’Œè¿æ¥
â”‚   â”‚   â”œâ”€â”€ instance_conf.go         # å®ä¾‹é…ç½®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ instance_info.go         # å®ä¾‹ä¿¡æ¯æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ request.go               # è¯·æ±‚æ•°æ®ç»“æ„
â”‚   â”‚   â”œâ”€â”€ response.go              # å“åº”æ•°æ®ç»“æ„
â”‚   â”‚   â”œâ”€â”€ scheduler.go             # è°ƒåº¦å™¨æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ settings.go              # è®¾ç½®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ template_conf.go         # æ¨¡æ¿é…ç½®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ template_info.go         # æ¨¡æ¿ä¿¡æ¯æ¨¡å‹
â”‚   â”œâ”€â”€ router/             # è·¯ç”±é…ç½®
â”‚   â”‚   â””â”€â”€ router.go                # HTTP è·¯ç”±è®¾ç½®
â”‚   â”œâ”€â”€ service/            # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ instance.go              # å®ä¾‹æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ instance_updater.go      # å®ä¾‹æ›´æ–°æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ notification.go          # é€šçŸ¥æœåŠ¡ (ServerChan)
â”‚   â”‚   â”œâ”€â”€ scheduler.go             # è°ƒåº¦å™¨æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ service_manager.go       # æœåŠ¡ç®¡ç†å™¨ï¼ˆä¾èµ–æ³¨å…¥ï¼‰
â”‚   â”‚   â””â”€â”€ websocket.go             # WebSocket æœåŠ¡
â”‚   â”œâ”€â”€ utils/              # å·¥å…·åº“
â”‚   â”‚   â”œâ”€â”€ close.go                 # å…³æœºå·¥å…·
â”‚   â”‚   â”œâ”€â”€ git.go                   # Git æ“ä½œå·¥å…·
â”‚   â”‚   â”œâ”€â”€ logger.go                # æ—¥å¿—å·¥å…·
â”‚   â”‚   â”œâ”€â”€ symlink.go               # ç¬¦å·é“¾æ¥å·¥å…·
â”‚   â”‚   â”œâ”€â”€ update.go                # æ›´æ–°å·¥å…·
â”‚   â”‚   â”œâ”€â”€ version.go               # ç‰ˆæœ¬ç®¡ç†å·¥å…·
â”‚   â”‚   â””â”€â”€ ws_manager.go            # WebSocket ç®¡ç†å™¨
â”‚   â””â”€â”€ server.go           # ç‹¬ç«‹ HTTP æœåŠ¡å™¨å…¥å£
â”œâ”€â”€ frontend/               # å‰ç«¯ Vue ä»£ç 
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ boot/          # Quasar å¯åŠ¨æ–‡ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ axios.ts           # Axios é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ i18n.ts            # å›½é™…åŒ–é…ç½®
â”‚   â”‚   â”œâ”€â”€ components/    # å¯å¤ç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ AppUpdateDialog.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ CardTitle.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ DirInput.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ FileInput.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ GroupCard.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ ItemLine.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ LogViewer.vue
â”‚   â”‚   â”‚   â””â”€â”€ TaskItem.vue
â”‚   â”‚   â”œâ”€â”€ css/           # å…¨å±€æ ·å¼
â”‚   â”‚   â”œâ”€â”€ i18n/          # å›½é™…åŒ–ç¿»è¯‘æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ pages/         # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ router/        # è·¯ç”±é…ç½®
â”‚   â”‚   â”œâ”€â”€ services/      # API æœåŠ¡å°è£…
â”‚   â”‚   â”œâ”€â”€ stores/        # Pinia çŠ¶æ€ç®¡ç†
â”‚   â”‚   â””â”€â”€ utils/         # å‰ç«¯å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ build/                  # æ„å»ºç›¸å…³æ–‡ä»¶
â”‚   â”œâ”€â”€ bin/               # æ„å»ºè¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ windows/           # Windows ç‰¹å®šé…ç½®
â”‚   â””â”€â”€ darwin/            # macOS ç‰¹å®šé…ç½®
â”œâ”€â”€ docs/                   # æ–‡æ¡£
â”‚   â”œâ”€â”€ å¼€å‘è€…æŒ‡å—.md
â”‚   â”œâ”€â”€ ç”¨æˆ·æŒ‡å—.md
â”‚   â””â”€â”€ å¼€å‘æ‰‹å†Œ.md        # æœ¬æ–‡æ¡£
â”œâ”€â”€ envs/                   # Python è™šæ‹Ÿç¯å¢ƒç›®å½•
â”œâ”€â”€ instances/              # å®ä¾‹é…ç½®æ–‡ä»¶å­˜å‚¨
â”œâ”€â”€ logs/                   # æ—¥å¿—æ–‡ä»¶ç›®å½•
â”œâ”€â”€ repos/                  # Git ä»“åº“å…‹éš†ç›®å½•
â”œâ”€â”€ tools/                  # å·¥å…·ç¨‹åºï¼ˆå¦‚ git.exe, uv.exeï¼‰
â”œâ”€â”€ main.go                 # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ wails.json             # Wails é…ç½®æ–‡ä»¶
â”œâ”€â”€ go.mod                 # Go ä¾èµ–ç®¡ç†
â””â”€â”€ settings.yml           # åº”ç”¨è®¾ç½®æ–‡ä»¶
```

### 3.2 æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

| æ–‡ä»¶è·¯å¾„                              | ä½œç”¨                                                   |
| ------------------------------------- | ------------------------------------------------------ |
| `main.go`                             | ç¨‹åºå…¥å£ï¼Œåˆå§‹åŒ–æ—¥å¿—ã€æ•°æ®åº“ã€HTTP æœåŠ¡å™¨å’Œ Wails åº”ç”¨ |
| `backend/app/app.go`                  | Wails åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå¯åŠ¨æ–‡ä»¶ç›‘æ§å’Œå®šæ—¶ä»»åŠ¡         |
| `backend/router/router.go`            | HTTP è·¯ç”±é…ç½®ï¼ŒWebSocket å‡çº§å¤„ç†                      |
| `backend/model/scheduler.go`          | è°ƒåº¦å™¨å•ä¾‹ï¼Œç®¡ç†æ‰€æœ‰å®ä¾‹çš„ä»»åŠ¡é˜Ÿåˆ—                     |
| `backend/service/scheduler.go`        | è°ƒåº¦å™¨ä¸šåŠ¡é€»è¾‘ï¼Œä»»åŠ¡æ‰§è¡Œå’ŒçŠ¶æ€ç®¡ç†                     |
| `backend/service/instance_updater.go` | å®ä¾‹æ›´æ–°æœåŠ¡ï¼Œå¤„ç† Git æ‹‰å–å’Œç¯å¢ƒç®¡ç†                  |
| `backend/service/notification.go`     | é€šçŸ¥æœåŠ¡ï¼Œå‘é€è°ƒåº¦ç»“æœåˆ° ServerChan                    |
| `backend/service/service_manager.go`  | æœåŠ¡ç®¡ç†å™¨ï¼Œä¾èµ–æ³¨å…¥å®¹å™¨                               |
| `backend/utils/git.go`                | Git å‘½ä»¤å°è£…ï¼Œæ”¯æŒè‡ªåŠ¨ä¸‹è½½ Git å·¥å…·                    |
| `frontend/src/pages/IndexPage.vue`    | ä¸»ç•Œé¢é¡µé¢                                             |
| `frontend/src/stores/`                | çŠ¶æ€ç®¡ç†ï¼ŒåŒ…æ‹¬å®ä¾‹ã€æ¨¡æ¿ã€è®¾ç½®ç­‰                       |

---

## 4. æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 4.1 Model å±‚ (æ•°æ®æ¨¡å‹)

#### 4.1.1 Scheduler (è°ƒåº¦å™¨)

**æ–‡ä»¶**: `backend/model/scheduler.go`

**æ ¸å¿ƒæ•°æ®ç»“æ„**:

```go
// ä»»åŠ¡çŠ¶æ€å¸¸é‡
const (
    StatusPending  = "pending"   // ç©ºé—²ç­‰å¾…
    StatusRunning  = "running"   // æ­£åœ¨æ‰§è¡Œ
    StatusUpdating = "updating"  // æ­£åœ¨æ›´æ–°ï¼ˆæ‹‰å–ä»£ç ï¼‰
    StatusFailed   = "failed"    // æ‰§è¡Œå¤±è´¥
)

// è°ƒåº¦å™¨æ‰§è¡Œç»“æœ
type SchedulerResult struct {
    Success      bool              // æ˜¯å¦å…¨éƒ¨æˆåŠŸ
    FailedCount  int               // å¤±è´¥æ•°é‡
    SuccessCount int               // æˆåŠŸæ•°é‡
    TotalCount   int               // æ€»æ•°é‡
    FailedNames  []string          // å¤±è´¥çš„å®ä¾‹åç§°åˆ—è¡¨
    Results      []InstanceResult  // æ‰€æœ‰å®ä¾‹çš„æ‰§è¡Œç»“æœ
}

// å•ä¸ªå®ä¾‹æ‰§è¡Œç»“æœ
type InstanceResult struct {
    Name     string  // å®ä¾‹åç§°
    TaskName string  // å¤±è´¥çš„ä»»åŠ¡åç§°ï¼ˆå¦‚æœæœ‰ï¼‰
    Success  bool    // æ˜¯å¦æˆåŠŸ
    Error    string  // é”™è¯¯ä¿¡æ¯
}

// ä»»åŠ¡é˜Ÿåˆ—
type TaskQueue struct {
    Running string   // æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å
    Waiting []string // ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨
    Stopped []string // å·²å®Œæˆçš„ä»»åŠ¡åˆ—è¡¨
}

// ä»»åŠ¡ç®¡ç†å™¨ï¼ˆå•ä¸ªå®ä¾‹ï¼‰
type TaskManager struct {
    InstanceName string       // å®ä¾‹åç§°
    Status       string        // å®ä¾‹çŠ¶æ€
    Queue        TaskQueue     // ä»»åŠ¡é˜Ÿåˆ—
    Cmd          *exec.Cmd     // å½“å‰æ‰§è¡Œçš„å‘½ä»¤è¿›ç¨‹
    ManualStop   bool          // æ˜¯å¦æ‰‹åŠ¨åœæ­¢
    LastError    string        // æœ€åçš„é”™è¯¯ä¿¡æ¯
}

// è°ƒåº¦å™¨ï¼ˆå…¨å±€å•ä¾‹ï¼‰
type Scheduler struct {
    TaskManagers map[string]*TaskManager  // æ‰€æœ‰å®ä¾‹çš„ä»»åŠ¡ç®¡ç†å™¨
    IsRunning    bool                      // è°ƒåº¦å™¨æ˜¯å¦è¿è¡Œä¸­
    CronExpr     string                    // Cron è¡¨è¾¾å¼
    AutoClose    bool                      // æ˜¯å¦è‡ªåŠ¨å…³æœº
    CloseFunc    func()                    // å…³æœºå›è°ƒå‡½æ•°
    mu           sync.Mutex                // äº’æ–¥é”
}
```

**å…³é”®æ–¹æ³•**:

| æ–¹æ³•                       | è¯´æ˜                                   |
| -------------------------- | -------------------------------------- |
| `GetScheduler()`           | è·å–è°ƒåº¦å™¨å•ä¾‹ï¼Œåˆå§‹åŒ–æ—¶åŒæ­¥æ•°æ®åº“çŠ¶æ€ |
| `Start()` / `Stop()`       | å¯åŠ¨/åœæ­¢è°ƒåº¦å™¨                        |
| `UpdateQueue(queues)`      | æ‰¹é‡æ›´æ–°å¤šä¸ªå®ä¾‹çš„ä»»åŠ¡é˜Ÿåˆ—             |
| `CancelTask(instanceName)` | å–æ¶ˆæŒ‡å®šå®ä¾‹çš„å½“å‰ä»»åŠ¡                 |
| `GetTaskManager(name)`     | è·å–æŒ‡å®šå®ä¾‹çš„ä»»åŠ¡ç®¡ç†å™¨               |
| `SyncWithDatabase()`       | ä»æ•°æ®åº“åŒæ­¥å®ä¾‹çŠ¶æ€åˆ°è°ƒåº¦å™¨           |

**è®¾è®¡è¦ç‚¹**:

- **å•ä¾‹æ¨¡å¼**: å…¨å±€åªæœ‰ä¸€ä¸ª Scheduler å®ä¾‹
- **çŠ¶æ€åŒæ­¥**: å¯åŠ¨æ—¶ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰å®ä¾‹çš„ä»»åŠ¡é˜Ÿåˆ—
- **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ mutex ä¿æŠ¤é˜Ÿåˆ—æ›´æ–°æ“ä½œ

#### 4.1.2 InstanceInfo (å®ä¾‹ä¿¡æ¯)

**æ–‡ä»¶**: `backend/model/instance_info.go`

**æ ¸å¿ƒæ•°æ®ç»“æ„**:

```go
// ä»»åŠ¡ä¿¡æ¯ï¼ˆæ•°æ®åº“è¡¨ï¼‰
type TaskInfo struct {
    gorm.Model
    InstanceID uint         // æ‰€å±å®ä¾‹ IDï¼ˆå¤–é”®ï¼‰
    Name       string       // ä»»åŠ¡åç§°
    Active     *bool        // æ˜¯å¦å¯ç”¨
    Priority   uint         // ä¼˜å…ˆçº§
    Command    string       // æ‰§è¡Œå‘½ä»¤
    // ...Disabled å­—æ®µè¡¨ç¤ºè¯¥é…ç½®é¡¹æ˜¯å¦å¯ç¼–è¾‘
}

// å®ä¾‹ä¿¡æ¯ï¼ˆæ•°æ®åº“è¡¨ï¼‰
type InstanceInfo struct {
    gorm.Model
    Name             string     // å®ä¾‹åç§°ï¼ˆå”¯ä¸€ï¼‰
    TemplateName     string     // æ¨¡æ¿åç§°
    Ready            bool       // æ˜¯å¦å°±ç»ª
    Language         string     // ç•Œé¢è¯­è¨€
    WorkDir          string     // å·¥ä½œç›®å½•
    Background       bool       // æ˜¯å¦åå°è¿è¡Œ
    ConfigPath       string     // é…ç½®æ–‡ä»¶è·¯å¾„
    LogPath          string     // æ—¥å¿—æ–‡ä»¶è·¯å¾„
    CronExpr         string     // å®šæ—¶è¡¨è¾¾å¼
    RepoURL          string     // Git ä»“åº“ URL
    LocalPath        string     // æœ¬åœ°è·¯å¾„
    Branch           string     // Git åˆ†æ”¯
    AutoUpdate       bool       // æ˜¯å¦è‡ªåŠ¨æ›´æ–°
    EnvName          string     // Python è™šæ‹Ÿç¯å¢ƒåç§°
    DepsPath         string     // ä¾èµ–æ–‡ä»¶è·¯å¾„
    PythonVersion    string     // Python ç‰ˆæœ¬
    Tasks            []TaskInfo // ä»»åŠ¡åˆ—è¡¨ï¼ˆä¸€å¯¹å¤šï¼‰
}
```

**å…³é”®æ–¹æ³•**:

| æ–¹æ³•                      | è¯´æ˜                                 |
| ------------------------- | ------------------------------------ |
| `GetAllInstances()`       | è·å–æ‰€æœ‰å®ä¾‹ä¿¡æ¯                     |
| `GetInstanceByName(name)` | æ ¹æ®åç§°è·å–å®ä¾‹                     |
| `GetByName(name)`         | è·å–å®ä¾‹ä¿¡æ¯ï¼ˆåŒ…æ‹¬ä»»åŠ¡åˆ—è¡¨ï¼‰         |
| `Create()`                | åˆ›å»ºæ–°å®ä¾‹                           |
| `Update()`                | æ›´æ–°å®ä¾‹ä¿¡æ¯                         |
| `Delete()`                | åˆ é™¤å®ä¾‹                             |
| `GetTaskQueue()`          | è·å–å®ä¾‹çš„ä»»åŠ¡é˜Ÿåˆ—ï¼ˆä»é…ç½®æ–‡ä»¶è§£æï¼‰ |
| `GetTaskByName(taskName)` | æ ¹æ®åç§°è·å–ä»»åŠ¡ä¿¡æ¯                 |
| `GetConfigMap()`          | è§£æé…ç½®æ–‡ä»¶ä¸º Map                   |

**è®¾è®¡è¦ç‚¹**:

- **é…ç½®æ–‡ä»¶é©±åŠ¨**: é…ç½®é¡¹ç”±æ¨¡æ¿å®šä¹‰ï¼Œå®ä¾‹ä¿å­˜ç”¨æˆ·è®¾ç½®
- **ä»»åŠ¡å…³è”**: é€šè¿‡ GORM å…³è”æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨
- **çµæ´»é…ç½®**: Disabled å­—æ®µæ§åˆ¶é…ç½®é¡¹æ˜¯å¦å¯ç¼–è¾‘

#### 4.1.3 TemplateInfo (æ¨¡æ¿ä¿¡æ¯)

**æ–‡ä»¶**: `backend/model/template_info.go`

**ä½œç”¨**: å­˜å‚¨ä» Git ä»“åº“è§£æçš„æ¨¡æ¿é…ç½®ä¿¡æ¯ï¼Œç”¨äºåˆ›å»ºå®ä¾‹æ—¶çš„é»˜è®¤å€¼

**æ ¸å¿ƒå­—æ®µ**:

- ä¸ InstanceInfo ç±»ä¼¼ï¼Œä½†ä¸åŒ…å«ç”¨æˆ·è‡ªå®šä¹‰çš„å€¼
- ç”¨äºåˆ›å»ºæ–°å®ä¾‹æ—¶çš„åˆå§‹åŒ–

#### 4.1.4 Settings (å…¨å±€è®¾ç½®)

**æ–‡ä»¶**: `backend/model/settings.go`

**ä½œç”¨**: ç®¡ç†åº”ç”¨çº§åˆ«çš„å…¨å±€è®¾ç½®ï¼ˆå­˜å‚¨åœ¨ `settings.yml`ï¼‰

**æ ¸å¿ƒå­—æ®µ**:

```go
type Settings struct {
    Language     string  // ç•Œé¢è¯­è¨€
    Theme        string  // ä¸»é¢˜
    AutoUpdate   bool    // æ˜¯å¦è‡ªåŠ¨æ›´æ–°åº”ç”¨
    // ...
}
```

---

### 4.2 Service å±‚ (ä¸šåŠ¡é€»è¾‘)

#### 4.2.1 SchedulerService (è°ƒåº¦æœåŠ¡)

**æ–‡ä»¶**: `backend/service/scheduler.go`

**æ ¸å¿ƒèŒè´£**: ç®¡ç†ä»»åŠ¡çš„æ‰§è¡Œæµç¨‹å’ŒçŠ¶æ€è½¬æ¢

**å…³é”®æ–¹æ³•**:

| æ–¹æ³•                                         | è¯´æ˜                         |
| -------------------------------------------- | ---------------------------- |
| `UpdateInstanceStatus(instanceName, status)` | æ›´æ–°å®ä¾‹çŠ¶æ€å¹¶å¹¿æ’­åˆ°å‰ç«¯     |
| `StartAll()`                                 | å¯åŠ¨æ‰€æœ‰å®ä¾‹çš„ä»»åŠ¡æ‰§è¡Œ       |
| `StartOne(instanceName)`                     | å¯åŠ¨å•ä¸ªå®ä¾‹çš„ä»»åŠ¡æ‰§è¡Œ       |
| `StopAll()`                                  | åœæ­¢æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®ä¾‹       |
| `RunCommand(tm, command, workDir)`           | æ‰§è¡Œå‘½ä»¤å¹¶å¤„ç†è¾“å‡º           |
| `processOutput(pipe, instanceName, isError)` | å¤„ç†å‘½ä»¤è¾“å‡ºæµï¼Œå®æ—¶æ¨é€æ—¥å¿— |

**ä»»åŠ¡æ‰§è¡Œæµç¨‹** (`StartAll`):

```
1. Scheduler.Start() â†’ çŠ¶æ€å˜ä¸º Running
2. ä»æ•°æ®åº“è·å–æ‰€æœ‰ Ready çš„å®ä¾‹
3. åˆ†ç±»ä¸ºå‰å°ä»»åŠ¡å’Œåå°ä»»åŠ¡
   - åå°ä»»åŠ¡ (Background=true): å¹¶å‘æ‰§è¡Œ
   - å‰å°ä»»åŠ¡ (Background=false): é¡ºåºæ‰§è¡Œ
4. åå°ä»»åŠ¡: å¯åŠ¨å¤šä¸ª goroutineï¼Œæ¯ä¸ªæ‰§è¡Œä¸€ä¸ªå®ä¾‹
5. å‰å°ä»»åŠ¡: æŒ‰é¡ºåºæ‰§è¡Œï¼Œé‡åˆ° Updating çŠ¶æ€ä¼šè·³è¿‡å¹¶é‡æ–°æ’é˜Ÿ
6. æ”¶é›†æ‰€æœ‰å®ä¾‹çš„æ‰§è¡Œç»“æœï¼ˆInstanceResultï¼‰
7. æ„å»ºè°ƒåº¦ç»“æœï¼ˆSchedulerResultï¼‰
8. å‘é€é€šçŸ¥ï¼ˆå¦‚æœé…ç½®äº† ServerChanï¼‰
9. Scheduler.Stop() â†’ çŠ¶æ€å˜ä¸º Pending
10. è§¦å‘ CloseFuncï¼ˆå¯èƒ½å…³æœºï¼‰
```

**ä»»åŠ¡çŠ¶æ€æµè½¬** (å•ä¸ªå®ä¾‹):

```
Pending â†’ (StartOne) â†’ Running â†’ (æ‰§è¡Œ) â†’ Pending/Failed
Pending â†’ (UpdateRepo) â†’ Updating â†’ (æ›´æ–°) â†’ Pending/Failed

çŠ¶æ€è¯´æ˜:
- Pending: å¾…æ‰§è¡Œ
- Running: æ‰§è¡Œä¸­
- Updating: æ›´æ–°ä¸­ (ä¸èƒ½è¢«å¯åŠ¨è¿è¡Œ)
- Failed: æ‰§è¡Œ/æ›´æ–°å¤±è´¥
```

**å‘½ä»¤æ‰§è¡Œç‰¹æ€§**:

- æ•è· stdout å’Œ stderr å®æ—¶æ¨é€åˆ°å‰ç«¯
- æ”¯æŒ GBK/UTF-8 ç¼–ç è‡ªåŠ¨æ£€æµ‹å’Œè½¬æ¢
- è®¾ç½®ç¯å¢ƒå˜é‡å¼ºåˆ¶å½©è‰²è¾“å‡º
- æ”¯æŒ Python è™šæ‹Ÿç¯å¢ƒè‡ªåŠ¨è¯†åˆ«

#### 4.2.2 InstanceUpdaterService (å®ä¾‹æ›´æ–°æœåŠ¡)

**æ–‡ä»¶**: `backend/service/instance_updater.go`

**æ ¸å¿ƒèŒè´£**: å¤„ç†å®ä¾‹çš„ä»£ç æ›´æ–°å’Œç¯å¢ƒç®¡ç†

**å…³é”®æ–¹æ³•**:

| æ–¹æ³•                                             | è¯´æ˜                     |
| ------------------------------------------------ | ------------------------ |
| `UpdateRepo(instanceName)`                       | æ›´æ–°ä»“åº“ä»£ç ã€ç¯å¢ƒå’Œé…ç½® |
| `createEnv(tm, envPath, pythonVersion)`          | åˆ›å»º Python è™šæ‹Ÿç¯å¢ƒ     |
| `installDeps(tm, envPath, depsPath, lastUpdate)` | å®‰è£… Python ä¾èµ–         |
| `CheckAndUpdate(istName)`                        | æ£€æŸ¥å¹¶è‡ªåŠ¨æ›´æ–°å®ä¾‹       |
| `RunUpdateTask(instances)`                       | æ‰¹é‡æ›´æ–°å®ä¾‹             |

**æ›´æ–°æµç¨‹** (`UpdateRepo`):

```
1. æ£€æŸ¥å®ä¾‹è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœæ­£åœ¨è¿è¡Œåˆ™æ‹’ç»æ›´æ–°
2. è®¾ç½®å®ä¾‹çŠ¶æ€ä¸º Updating
3. ç§»é™¤é…ç½®æ–‡ä»¶ç¬¦å·é“¾æ¥
4. æ‰§è¡Œ git pull æ‹‰å–æœ€æ–°ä»£ç 
5. é‡æ–°åˆ›å»ºç¬¦å·é“¾æ¥
6. å¦‚æœé…ç½®äº†è™šæ‹Ÿç¯å¢ƒ:
   a. åˆ›å»º/æ›´æ–° Python è™šæ‹Ÿç¯å¢ƒ (ä½¿ç”¨ uv)
   b. å®‰è£…/æ›´æ–°ä¾èµ– (requirements.txt)
   c. æ›´æ–° EnvLastUpdate æ—¶é—´æˆ³
7. æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ˜¯å¦æ›´æ–°:
   - å¦‚æœæ›´æ–°ï¼Œé‡æ–°è§£æé…ç½®å¹¶æ›´æ–°æ•°æ®åº“
8. æ¢å¤å®ä¾‹çŠ¶æ€ä¸º Pending/Failed
```

**Python ç¯å¢ƒç®¡ç†**:

- ä½¿ç”¨ `uv` å·¥å…·ç®¡ç†è™šæ‹Ÿç¯å¢ƒï¼ˆæ¯” pip æ›´å¿«ï¼‰
- æ”¯æŒæŒ‡å®š Python ç‰ˆæœ¬
- ä¾èµ–æ–‡ä»¶ä¿®æ”¹æ—¶é—´æˆ³å¯¹æ¯”ï¼Œé¿å…é‡å¤å®‰è£…

#### 4.2.3 WebSocketService (WebSocket æœåŠ¡)

**æ–‡ä»¶**: `backend/service/websocket.go`

**æ ¸å¿ƒèŒè´£**: å®æ—¶æ¨é€æ•°æ®åˆ°å‰ç«¯

**å…³é”®æ–¹æ³•**:

| æ–¹æ³•                                   | è¯´æ˜                |
| -------------------------------------- | ------------------- |
| `HandleConnection(conn, handler)`      | å¤„ç† WebSocket è¿æ¥ |
| `BroadcastState(instanceName, status)` | å¹¿æ’­å®ä¾‹çŠ¶æ€å˜åŒ–    |
| `BroadcastQueue(instanceName)`         | å¹¿æ’­ä»»åŠ¡é˜Ÿåˆ—æ›´æ–°    |
| `BroadcastLog(instanceName, log)`      | å¹¿æ’­å®æ—¶æ—¥å¿—        |
| `SendQueue(conn)`                      | å‘é€åˆå§‹ä»»åŠ¡é˜Ÿåˆ—    |
| `SendState(conn)`                      | å‘é€åˆå§‹çŠ¶æ€        |

**æ¶ˆæ¯ç±»å‹**:

| Type               | è¯´æ˜            | æ•°æ®æ ¼å¼                                             |
| ------------------ | --------------- | ---------------------------------------------------- |
| `state`            | å®ä¾‹/è°ƒåº¦å™¨çŠ¶æ€ | `{instanceName, status}`                             |
| `queue`            | ä»»åŠ¡é˜Ÿåˆ—        | `{instanceName, queue: {running, waiting, stopped}}` |
| `log`              | å®æ—¶æ—¥å¿—        | `{instanceName, message}`                            |
| `update_available` | åº”ç”¨æ›´æ–°å¯ç”¨    | `{version, releaseNotes}`                            |

**è¿æ¥ç®¡ç†**:

- ä½¿ç”¨ `WSManager` ç»´æŠ¤æ‰€æœ‰æ´»è·ƒè¿æ¥
- æ–°è¿æ¥å»ºç«‹æ—¶å‘é€åˆå§‹çŠ¶æ€å’Œé˜Ÿåˆ—
- å¹¿æ’­æ¶ˆæ¯æ—¶éå†æ‰€æœ‰è¿æ¥

#### 4.2.4 NotificationService (é€šçŸ¥æœåŠ¡)

**æ–‡ä»¶**: `backend/service/notification.go`

**æ ¸å¿ƒèŒè´£**: å‘é€è°ƒåº¦å™¨æ‰§è¡Œç»“æœé€šçŸ¥åˆ° ServerChan

**å…³é”®æ–¹æ³•**:

| æ–¹æ³•                                | è¯´æ˜                         |
| ----------------------------------- | ---------------------------- |
| `SendSchedulerNotification(result)` | å‘é€è°ƒåº¦ç»“æœé€šçŸ¥             |
| `buildTitle(result)`                | æ„å»ºé€šçŸ¥æ ‡é¢˜                 |
| `buildContent(result)`              | æ„å»º Markdown æ ¼å¼çš„é€šçŸ¥å†…å®¹ |

**é€šçŸ¥æ ¼å¼**:

**æ ‡é¢˜**:

- æˆåŠŸ: `âœ… è°ƒåº¦å™¨è¿è¡ŒæˆåŠŸ (3/3)`
- å¤±è´¥: `âŒ è°ƒåº¦å™¨è¿è¡Œå¤±è´¥ - Instance1ã€Instance2`

**å†…å®¹** (Markdown):

```markdown
## ğŸ“Š è¿è¡Œæ¦‚å†µ

- **æ€»å®ä¾‹æ•°**: 3
- **æˆåŠŸ**: 2 âœ…
- **å¤±è´¥**: 1 âŒ

---

## âœ… æˆåŠŸå®ä¾‹

- **Instance1**: è¿è¡ŒæˆåŠŸ
- **Instance2**: è¿è¡ŒæˆåŠŸ

## âŒ å¤±è´¥å®ä¾‹

### Instance3 - ä»»åŠ¡: æ¯æ—¥ç­¾åˆ°
```

command failed with exit code 1:
Traceback (most recent call last):
File "task.py", line 10, in <module>
raise Exception("Task failed")
Exception: Task failed

```

```

**é”™è¯¯ä¿¡æ¯æ•è·**:

- æ•è· stderr è¾“å‡ºï¼Œæœ€å¤š 2000 å­—ç¬¦
- åŒ…å«ä»»åŠ¡åç§°å’Œå…·ä½“é”™è¯¯å †æ ˆ
- è‡ªåŠ¨æˆªæ–­è¿‡é•¿çš„é”™è¯¯ä¿¡æ¯

**é…ç½®**:

- åœ¨å‰ç«¯è®¾ç½®é¡µé¢é…ç½® ServerChan SendKey
- SendKey å­˜å‚¨åœ¨ `settings.yml` ä¸­
- æ”¯æŒçƒ­é‡è½½ï¼ˆä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼‰

#### 4.2.5 ServiceManager (æœåŠ¡ç®¡ç†å™¨)

**æ–‡ä»¶**: `backend/service/service_manager.go`

**æ ¸å¿ƒèŒè´£**: ä¾èµ–æ³¨å…¥å®¹å™¨ï¼Œç®¡ç†æ‰€æœ‰æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸ

**æ¶æ„æ¨¡å¼**: å•ä¾‹æ¨¡å¼ + ä¾èµ–æ³¨å…¥

**æœåŠ¡ä¾èµ–å…³ç³»**:

```
ServiceManager (å•ä¾‹)
â”œâ”€â”€ InstanceService          (æ— ä¾èµ–)
â”œâ”€â”€ WebSocketService         (æ— ä¾èµ–)
â”œâ”€â”€ NotificationService      (æ— ä¾èµ–ï¼Œå¯é€‰)
â”œâ”€â”€ SchedulerService         (ä¾èµ–: wsService, notifService)
â””â”€â”€ InstanceUpdaterService   (ä¾èµ–: schedulerService, wsService)
```

**å…³é”®æ–¹æ³•**:

| æ–¹æ³•                          | è¯´æ˜                     |
| ----------------------------- | ------------------------ |
| `GetServiceManager()`         | è·å–å•ä¾‹å®ä¾‹             |
| `init()`                      | åˆå§‹åŒ–æ‰€æœ‰æœåŠ¡å¹¶æ³¨å…¥ä¾èµ– |
| `InstanceService()`           | è·å–å®ä¾‹æœåŠ¡             |
| `SchedulerService()`          | è·å–è°ƒåº¦å™¨æœåŠ¡           |
| `InstanceUpdaterService()`    | è·å–å®ä¾‹æ›´æ–°æœåŠ¡         |
| `WebSocketService()`          | è·å– WebSocket æœåŠ¡      |
| `NotificationService()`       | è·å–é€šçŸ¥æœåŠ¡             |
| `ReloadNotificationService()` | çƒ­é‡è½½é€šçŸ¥æœåŠ¡é…ç½®       |

**åˆå§‹åŒ–æµç¨‹**:

```
1. åŠ è½½ settings.yml é…ç½®
2. åˆ›å»º WebSocketServiceï¼ˆæ— ä¾èµ–ï¼‰
3. åˆ›å»º NotificationServiceï¼ˆå¦‚æœé…ç½®äº† SendKeyï¼‰
4. åˆ›å»º SchedulerServiceï¼ˆæ³¨å…¥ wsService å’Œ notifServiceï¼‰
5. åˆ›å»º InstanceServiceï¼ˆæ— ä¾èµ–ï¼‰
6. åˆ›å»º InstanceUpdaterServiceï¼ˆæ³¨å…¥ schedulerService å’Œ wsServiceï¼‰
```

**çƒ­é‡è½½æœºåˆ¶**:

- ç”¨æˆ·åœ¨å‰ç«¯ä¿®æ”¹ ServerChan SendKey
- `settings_ctrl.UpdateSettings()` è°ƒç”¨ `ReloadNotificationService()`
- é‡æ–°åˆ›å»º NotificationService å¹¶æ›´æ–°åˆ° SchedulerService
- ä¸‹æ¬¡è°ƒåº¦æ‰§è¡Œæ—¶è‡ªåŠ¨ä½¿ç”¨æ–°é…ç½®

**è®¾è®¡ä¼˜åŠ¿**:

- âœ… ç»Ÿä¸€ç®¡ç†æœåŠ¡ç”Ÿå‘½å‘¨æœŸ
- âœ… ä¾èµ–å…³ç³»æ¸…æ™°æ˜ç¡®
- âœ… æ”¯æŒè¿è¡Œæ—¶çƒ­é‡è½½
- âœ… æ˜“äºæµ‹è¯•å’Œ mock
- âœ… é¿å…åŒ…çº§å˜é‡ç¼“å­˜å¯¼è‡´çš„çŠ¶æ€ä¸ä¸€è‡´

#### 4.2.6 InstanceService (å®ä¾‹æœåŠ¡)

**æ–‡ä»¶**: `backend/service/instance.go`

**æ ¸å¿ƒèŒè´£**: å®ä¾‹çš„åˆ›å»ºã€å¯¼å…¥å’Œé…ç½®ç®¡ç†

**å…³é”®æ–¹æ³•**:

| æ–¹æ³•                                 | è¯´æ˜            |
| ------------------------------------ | --------------- |
| `CreateInstance(name, tplName)`      | åˆ›å»ºæ–°å®ä¾‹      |
| `ImportTemplate(url, branch)`        | ä» Git å¯¼å…¥æ¨¡æ¿ |
| `GetInstanceConfig(name)`            | è·å–å®ä¾‹é…ç½®    |
| `UpdateInstanceConfig(name, config)` | æ›´æ–°å®ä¾‹é…ç½®    |

---

### 4.3 Controller å±‚ (HTTP è¯·æ±‚å¤„ç†)

#### 4.3.1 è·¯ç”±é…ç½®

**æ–‡ä»¶**: `backend/router/router.go`

**HTTP æœåŠ¡å™¨é…ç½®**:

- ç«¯å£: `48596`
- æ¡†æ¶: Gin
- è·¨åŸŸ: å…è®¸ `wails.localhost` å’Œ `localhost:33204`
- æ—¥å¿—: è‡ªå®šä¹‰æ ¼å¼ï¼Œè¾“å‡ºåˆ°æ–‡ä»¶å’Œæ§åˆ¶å°

**è·¯ç”±è¡¨**:

| è·¯å¾„                              | æ–¹æ³•      | Controller              | è¯´æ˜                |
| --------------------------------- | --------- | ----------------------- | ------------------- |
| `/api/instance`                   | POST      | `CreateIstFromLocal`    | ä»æœ¬åœ°ç›®å½•åˆ›å»ºå®ä¾‹  |
| `/api/instance/template`          | POST      | `CreateIstFromTemplate` | ä»æ¨¡æ¿åˆ›å»ºå®ä¾‹      |
| `/api/instance/remote`            | POST      | `CreateIstFromRemote`   | ä»è¿œç¨‹ Git åˆ›å»ºå®ä¾‹ |
| `/api/instance`                   | GET       | `GetAllInstances`       | è·å–æ‰€æœ‰å®ä¾‹        |
| `/api/instance/:name`             | GET       | `GetInstance`           | è·å–å•ä¸ªå®ä¾‹        |
| `/api/instance/:name`             | PATCH     | `UpdateInstance`        | æ›´æ–°å®ä¾‹é…ç½®        |
| `/api/instance/:name`             | DELETE    | `DeleteInstance`        | åˆ é™¤å®ä¾‹            |
| `/api/template`                   | GET       | `GetTemplate`           | è·å–æ‰€æœ‰æ¨¡æ¿        |
| `/api/template/:name`             | DELETE    | `DeleteTemplate`        | åˆ é™¤æ¨¡æ¿            |
| `/api/scheduler`                  | POST      | `UpdateScheduler`       | æ›´æ–°è°ƒåº¦å™¨çŠ¶æ€      |
| `/api/scheduler/task-queue`       | POST      | `UpdateTaskQueue`       | æ›´æ–°ä»»åŠ¡é˜Ÿåˆ—        |
| `/api/scheduler/task-queue/:name` | GET       | `GetTaskQueue`          | è·å–ä»»åŠ¡é˜Ÿåˆ—        |
| `/api/settings`                   | GET       | `GetSettings`           | è·å–è®¾ç½®            |
| `/api/settings`                   | PATCH     | `UpdateSettings`        | æ›´æ–°è®¾ç½®            |
| `/api/update/instance/:name`      | POST      | `UpdateRepo`            | æ›´æ–°å®ä¾‹ä»“åº“        |
| `/api/update/check`               | POST      | `CheckUpdate`           | æ£€æŸ¥åº”ç”¨æ›´æ–°        |
| `/ws`                             | WebSocket | -                       | WebSocket è¿æ¥      |

#### 4.3.2 å…³é”® Controller

**InstanceController** (`backend/controller/instance_ctrl.go`):

- å¤„ç†å®ä¾‹çš„ CRUD æ“ä½œ
- åˆ›å»ºå®ä¾‹æ—¶è°ƒç”¨ `InstanceService`
- è¿”å›ç»Ÿä¸€æ ¼å¼çš„ JSON å“åº”

**SchedulerController** (`backend/controller/scheduler_ctrl.go`):

- å¤„ç†è°ƒåº¦å™¨çš„å¯åŠ¨/åœæ­¢
- æ›´æ–°ä»»åŠ¡é˜Ÿåˆ—
- è°ƒç”¨ `SchedulerService` æ‰§è¡Œä»»åŠ¡

**InstanceUpdaterController** (`backend/controller/instance_updater_ctrl.go`):

- å¤„ç†å®ä¾‹æ›´æ–°è¯·æ±‚
- è°ƒç”¨ `InstanceUpdaterService.UpdateRepo()`
- è¿”å›æ›´æ–°ç»“æœ

#### 4.3.3 æœåŠ¡è®¿é—®è§„èŒƒ

**æ–‡ä»¶**: `backend/controller/services.go`

```go
package controller

import "dacapo/backend/service"

// Services provides access to all service instances
var Services = service.GetServiceManager()
```

**Controller ä¸­æ­£ç¡®ä½¿ç”¨æœåŠ¡**:

```go
// âŒ é”™è¯¯ï¼šåŒ…çº§å˜é‡ç¼“å­˜æœåŠ¡
var schedulerService = Services.SchedulerService()

func Handler(c *gin.Context) {
    schedulerService.DoSomething()  // æ— æ³•å“åº”çƒ­é‡è½½
}

// âœ… æ­£ç¡®ï¼šæ¯æ¬¡è°ƒç”¨æ—¶è·å–æœåŠ¡
func Handler(c *gin.Context) {
    Services.SchedulerService().DoSomething()  // æ€»æ˜¯è·å–æœ€æ–°çŠ¶æ€
}
```

**ä¸ºä»€ä¹ˆä¸èƒ½ç¼“å­˜æœåŠ¡å¼•ç”¨**:

1. **çƒ­é‡è½½å¤±æ•ˆ**: åŒ…çº§å˜é‡åœ¨åˆå§‹åŒ–æ—¶å°±å›ºå®šäº†å¼•ç”¨ï¼Œæ— æ³•å“åº”é…ç½®å˜æ›´
2. **çŠ¶æ€ä¸ä¸€è‡´**: ServiceManager ä¸­çš„æœåŠ¡æ›´æ–°äº†ï¼Œä½†ç¼“å­˜çš„å¼•ç”¨è¿˜æ˜¯æ—§çš„
3. **æ€§èƒ½å½±å“å¾®ä¹å…¶å¾®**: è·å–æœåŠ¡å¼•ç”¨åªæ˜¯è¿”å›ä¸€ä¸ªæŒ‡é’ˆï¼ŒO(1) æ“ä½œ

**ç¤ºä¾‹**:

```go
// settings_ctrl.go
func UpdateSettings(c *gin.Context) {
    // ç”¨æˆ·ä¿®æ”¹äº† ServerChan SendKey
    if req.ServerChanSendKey != nil {
        sm := service.GetServiceManager()
        sm.ReloadNotificationService()  // é‡æ–°åŠ è½½æœåŠ¡
    }

    // ä¸‹æ¬¡è°ƒç”¨æ—¶ä¼šè·å–æ–°çš„æœåŠ¡å®ä¾‹
    Services.SchedulerService().StartAll()  // âœ… ä½¿ç”¨æ–°é…ç½®
}
```

**è®¾è®¡æ¨¡å¼**: ä¾èµ–æ³¨å…¥ï¼Œé¿å…åŒ…çº§å˜é‡ç¼“å­˜

---

### 4.4 Utils å·¥å…·æ¨¡å—

#### 4.4.1 Git å·¥å…·

**æ–‡ä»¶**: `backend/utils/git.go`

**æ ¸å¿ƒåŠŸèƒ½**: Git å‘½ä»¤å°è£…ï¼Œæ”¯æŒè‡ªåŠ¨ä¸‹è½½ Git å·¥å…·

**å…³é”®å‡½æ•°**:

| å‡½æ•°                              | è¯´æ˜                    |
| --------------------------------- | ----------------------- |
| `GitClone(url, localDir, branch)` | å…‹éš†ä»“åº“ï¼ˆå¸¦å­æ¨¡å—ï¼‰    |
| `GitCheckout(repoPath, branch)`   | åˆ‡æ¢åˆ†æ”¯                |
| `GitPull(repoPath)`               | æ‹‰å–æœ€æ–°ä»£ç             |
| `getGitExecutable()`              | è·å– Git å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ |
| `downloadGit()`                   | è‡ªåŠ¨ä¸‹è½½ Git å·¥å…·       |

**Git æŸ¥æ‰¾é€»è¾‘**:

```
1. å°è¯•ä½¿ç”¨ç³»ç»Ÿ git å‘½ä»¤
2. å¦‚æœå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ tools/git/cmd/git.exe
3. å¦‚æœéƒ½æ²¡æœ‰ï¼Œæ ¹æ®ç”¨æˆ·åœ°åŒºä¸‹è½½ Git:
   - ä¸­å›½: ä» Gitee ä¸‹è½½
   - å…¶ä»–: ä» GitHub ä¸‹è½½
4. è§£å‹åˆ° tools/git ç›®å½•
5. è¿”å› git.exe è·¯å¾„
```

**Pull ç­–ç•¥**:

- æ— å†²çª: æ­£å¸¸åˆå¹¶ï¼Œä¿ç•™æœ¬åœ°å’Œè¿œç¨‹ä¿®æ”¹
- æœ‰å†²çª: `reset --hard` åˆ°è¿œç¨‹åˆ†æ”¯ï¼Œæ”¾å¼ƒå†²çªçš„æœ¬åœ°ä¿®æ”¹
- æœªè·Ÿè¸ªæ–‡ä»¶: ä¿ç•™ï¼ˆä¸ä¼šè¢« reset å½±å“ï¼‰

#### 4.4.2 æ—¥å¿—å·¥å…·

**æ–‡ä»¶**: `backend/utils/logger.go`

**åŠŸèƒ½**: åŸºäº zap çš„æ—¥å¿—ç³»ç»Ÿï¼Œæ”¯æŒæ–‡ä»¶è½®è½¬

**é…ç½®**:

- æ—¥å¿—ç›®å½•: `logs/`
- æ–‡ä»¶å: `app.log`
- è½®è½¬ç­–ç•¥: å•æ–‡ä»¶æœ€å¤§ 10MBï¼Œä¿ç•™ 30 ä¸ªå¤‡ä»½ï¼Œæœ€å¤š 30 å¤©

**æ—¥å¿—çº§åˆ«**:

```go
Logger.Debug("è°ƒè¯•ä¿¡æ¯")
Logger.Info("æ™®é€šä¿¡æ¯")
Logger.Warn("è­¦å‘Šä¿¡æ¯")
Logger.Error("é”™è¯¯ä¿¡æ¯")
Logger.Fatal("è‡´å‘½é”™è¯¯")
```

#### 4.4.3 ç¬¦å·é“¾æ¥å·¥å…·

**æ–‡ä»¶**: `backend/utils/symlink.go`

**åŠŸèƒ½**: ç®¡ç†é…ç½®æ–‡ä»¶çš„ç¬¦å·é“¾æ¥

**å…³é”®å‡½æ•°**:

| å‡½æ•°                      | è¯´æ˜               |
| ------------------------- | ------------------ |
| `CheckLink(target, link)` | æ£€æŸ¥å¹¶åˆ›å»ºç¬¦å·é“¾æ¥ |
| `RemoveLink(link)`        | ç§»é™¤ç¬¦å·é“¾æ¥       |

**ç”¨é€”**: å°†ä»“åº“ä¸­çš„é…ç½®æ–‡ä»¶é“¾æ¥åˆ° `instances/` ç›®å½•ï¼Œæ–¹ä¾¿ç®¡ç†

#### 4.4.4 æ›´æ–°å·¥å…·

**æ–‡ä»¶**: `backend/utils/update.go`

**åŠŸèƒ½**: åº”ç”¨è‡ªåŠ¨æ›´æ–°

**å…³é”®å‡½æ•°**:

| å‡½æ•°                         | è¯´æ˜               |
| ---------------------------- | ------------------ |
| `CheckForUpdates()`          | æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬   |
| `DownloadAndInstallUpdate()` | ä¸‹è½½å¹¶å®‰è£…æ›´æ–°     |
| `getCountry()`               | è·å–ç”¨æˆ·æ‰€åœ¨å›½å®¶   |
| `getUrls()`                  | æ ¹æ®å›½å®¶é€‰æ‹©ä¸‹è½½æº |

**æ›´æ–°æµç¨‹**:

```
1. ä»è¿œç¨‹è·å– version.txt
2. å¯¹æ¯”å½“å‰ç‰ˆæœ¬å·
3. å¦‚æœæœ‰æ–°ç‰ˆæœ¬ï¼Œä¸‹è½½ .exe æ–‡ä»¶
4. éªŒè¯ç­¾åï¼ˆ.ed25519ï¼‰
5. æ›¿æ¢å½“å‰å¯æ‰§è¡Œæ–‡ä»¶
6. é‡å¯åº”ç”¨
```

#### 4.4.5 WebSocket ç®¡ç†å™¨

**æ–‡ä»¶**: `backend/utils/ws_manager.go`

**åŠŸèƒ½**: ç®¡ç†æ‰€æœ‰ WebSocket è¿æ¥

**æ ¸å¿ƒç»“æ„**:

```go
type WSManager struct {
    clients map[*websocket.Conn]bool
    mu      sync.RWMutex
}
```

**å…³é”®æ–¹æ³•**:

| æ–¹æ³•                      | è¯´æ˜               |
| ------------------------- | ------------------ |
| `RegisterClient(conn)`    | æ³¨å†Œæ–°è¿æ¥         |
| `RemoveClient(conn)`      | ç§»é™¤è¿æ¥           |
| `BroadcastJSON(message)`  | å‘æ‰€æœ‰è¿æ¥å¹¿æ’­æ¶ˆæ¯ |
| `SendJSON(conn, message)` | å‘å•ä¸ªè¿æ¥å‘é€æ¶ˆæ¯ |

#### 4.4.6 å…³æœºå·¥å…·

**æ–‡ä»¶**: `backend/utils/close.go`

**åŠŸèƒ½**: è·¨å¹³å°å…³æœº/ä¼‘çœ 

**å…³é”®å‡½æ•°**:

| å‡½æ•°         | è¯´æ˜ |
| ------------ | ---- |
| `Shutdown()` | å…³æœº |
| `Sleep()`    | ä¼‘çœ  |

**å®ç°**:

- Windows: ä½¿ç”¨ `shutdown.exe` å‘½ä»¤
- Linux/macOS: ä½¿ç”¨ `systemctl` æˆ– `pmset` å‘½ä»¤

---

### 4.5 å‰ç«¯æ¶æ„

#### 4.5.1 æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Vue 3 (Composition API + TypeScript)
- **UI åº“**: Quasar Framework
- **çŠ¶æ€ç®¡ç†**: Pinia
- **HTTP**: Axios
- **WebSocket**: åŸç”Ÿ WebSocket API
- **æ„å»º**: Vite

#### 4.5.2 ç›®å½•ç»“æ„

```
frontend/src/
â”œâ”€â”€ boot/               # Quasar å¯åŠ¨æ–‡ä»¶
â”‚   â”œâ”€â”€ axios.ts       # Axios é…ç½®ï¼ˆbaseURL, æ‹¦æˆªå™¨ï¼‰
â”‚   â””â”€â”€ i18n.ts        # i18n é…ç½®
â”œâ”€â”€ components/         # å¯å¤ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ AppUpdateDialog.vue    # åº”ç”¨æ›´æ–°å¯¹è¯æ¡†
â”‚   â”œâ”€â”€ CardTitle.vue          # å¡ç‰‡æ ‡é¢˜
â”‚   â”œâ”€â”€ DirInput.vue           # ç›®å½•é€‰æ‹©è¾“å…¥æ¡†
â”‚   â”œâ”€â”€ FileInput.vue          # æ–‡ä»¶é€‰æ‹©è¾“å…¥æ¡†
â”‚   â”œâ”€â”€ GroupCard.vue          # åˆ†ç»„å¡ç‰‡
â”‚   â”œâ”€â”€ ItemLine.vue           # é…ç½®é¡¹è¡Œ
â”‚   â”œâ”€â”€ LogViewer.vue          # æ—¥å¿—æŸ¥çœ‹å™¨
â”‚   â””â”€â”€ TaskItem.vue           # ä»»åŠ¡é¡¹
â”œâ”€â”€ css/                # å…¨å±€æ ·å¼
â”‚   â”œâ”€â”€ app.scss       # åº”ç”¨æ ·å¼
â”‚   â””â”€â”€ quasar.variables.scss  # Quasar å˜é‡
â”œâ”€â”€ i18n/               # å›½é™…åŒ–
â”‚   â”œâ”€â”€ index.ts       # i18n é…ç½®
â”‚   â”œâ”€â”€ en-US/         # è‹±æ–‡ç¿»è¯‘
â”‚   â””â”€â”€ zh-CN/         # ä¸­æ–‡ç¿»è¯‘
â”œâ”€â”€ pages/              # é¡µé¢ç»„ä»¶
â”‚   â”œâ”€â”€ MainPage.vue           # ä¸»é¡µï¼ˆåŒ…å«å·¦ä¾§å¯¼èˆªï¼‰
â”‚   â”œâ”€â”€ HomePage.vue           # é¦–é¡µï¼ˆå®ä¾‹åˆ—è¡¨ï¼‰
â”‚   â”œâ”€â”€ WelcomePage.vue        # æ¬¢è¿é¡µï¼ˆæ— å®ä¾‹æ—¶ï¼‰
â”‚   â”œâ”€â”€ InstancePage.vue       # å®ä¾‹è¯¦æƒ…é¡µï¼ˆåŠ¨æ€è·¯ç”±ï¼‰
â”‚   â”œâ”€â”€ GeneralPage.vue        # é€šç”¨è®¾ç½®é¡µ
â”‚   â”œâ”€â”€ UpdatePage.vue         # æ›´æ–°è®¾ç½®é¡µ
â”‚   â”œâ”€â”€ CustomPage.vue         # è‡ªå®šä¹‰é…ç½®é¡µ
â”‚   â””â”€â”€ SettingsPage.vue       # åº”ç”¨è®¾ç½®é¡µ
â”œâ”€â”€ router/             # è·¯ç”±
â”‚   â”œâ”€â”€ index.ts       # è·¯ç”±å®ä¾‹
â”‚   â””â”€â”€ routes.ts      # è·¯ç”±é…ç½®
â”œâ”€â”€ services/           # API æœåŠ¡
â”‚   â”œâ”€â”€ http.ts        # HTTP è¯·æ±‚å°è£…
â”‚   â””â”€â”€ websocket.ts   # WebSocket å°è£…
â”œâ”€â”€ stores/             # Pinia çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ index.ts       # Store å¯¼å‡º
â”‚   â””â”€â”€ global-store.ts # å…¨å±€çŠ¶æ€
â””â”€â”€ utils/              # å·¥å…·å‡½æ•°
    â””â”€â”€ helpers.ts      # è¾…åŠ©å‡½æ•°
```

#### 4.5.3 çŠ¶æ€ç®¡ç† (Pinia)

**æ–‡ä»¶**: `frontend/src/stores/global-store.ts`

**å…¨å±€çŠ¶æ€**:

```typescript
interface GlobalState {
  // å®ä¾‹ç›¸å…³
  instances: InstanceInfo[]; // æ‰€æœ‰å®ä¾‹
  currentInstance: InstanceInfo | null; // å½“å‰å®ä¾‹

  // æ¨¡æ¿ç›¸å…³
  templates: TemplateInfo[]; // æ‰€æœ‰æ¨¡æ¿

  // è°ƒåº¦å™¨ç›¸å…³
  schedulerState: string; // è°ƒåº¦å™¨çŠ¶æ€
  taskQueues: Record<string, TaskQueue>; // ä»»åŠ¡é˜Ÿåˆ—

  // WebSocket
  wsConnected: boolean; // WebSocket è¿æ¥çŠ¶æ€

  // è®¾ç½®
  settings: Settings; // åº”ç”¨è®¾ç½®
}
```

**å…³é”® Actions**:

| Action                         | è¯´æ˜                    |
| ------------------------------ | ----------------------- |
| `fetchInstances()`             | ä»åç«¯è·å–æ‰€æœ‰å®ä¾‹      |
| `fetchTemplates()`             | è·å–æ‰€æœ‰æ¨¡æ¿            |
| `createInstance(data)`         | åˆ›å»ºæ–°å®ä¾‹              |
| `updateInstance(name, data)`   | æ›´æ–°å®ä¾‹é…ç½®            |
| `deleteInstance(name)`         | åˆ é™¤å®ä¾‹                |
| `startScheduler(name?)`        | å¯åŠ¨è°ƒåº¦å™¨ï¼ˆå•ä¸ª/å…¨éƒ¨ï¼‰ |
| `stopScheduler(name?)`         | åœæ­¢è°ƒåº¦å™¨ï¼ˆå•ä¸ª/å…¨éƒ¨ï¼‰ |
| `updateTaskQueue(name, queue)` | æ›´æ–°ä»»åŠ¡é˜Ÿåˆ—            |
| `connectWebSocket()`           | å»ºç«‹ WebSocket è¿æ¥     |

#### 4.5.4 WebSocket é€šä¿¡

**æ–‡ä»¶**: `frontend/src/services/websocket.ts`

**è¿æ¥ç®¡ç†**:

```typescript
class WebSocketService {
  private ws: WebSocket | null;
  private reconnectTimer: number;

  connect(url: string) {
    // å»ºç«‹è¿æ¥
    this.ws = new WebSocket(url);

    // ç›‘å¬æ¶ˆæ¯
    this.ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      this.handleMessage(data);
    };

    // æ–­çº¿é‡è¿
    this.ws.onclose = () => {
      setTimeout(() => this.connect(url), 3000);
    };
  }

  handleMessage(data: any) {
    switch (data.type) {
      case "state":
        // æ›´æ–°å®ä¾‹çŠ¶æ€
        store.updateInstanceState(data.instanceName, data.status);
        break;
      case "queue":
        // æ›´æ–°ä»»åŠ¡é˜Ÿåˆ—
        store.updateTaskQueue(data.instanceName, data.queue);
        break;
      case "log":
        // æ·»åŠ æ—¥å¿—
        store.appendLog(data.instanceName, data.message);
        break;
    }
  }
}
```

**æ¶ˆæ¯ç±»å‹å¤„ç†**:

- `state`: æ›´æ–°å®ä¾‹/è°ƒåº¦å™¨çŠ¶æ€ï¼Œè§¦å‘ç•Œé¢æ›´æ–°
- `queue`: æ›´æ–°ä»»åŠ¡é˜Ÿåˆ—ï¼Œåˆ·æ–°ä»»åŠ¡åˆ—è¡¨
- `log`: è¿½åŠ æ—¥å¿—åˆ°æ—¥å¿—æŸ¥çœ‹å™¨

#### 4.5.5 é¡µé¢ç»„ä»¶

**MainPage** (`pages/MainPage.vue`):

- å·¦ä¾§æŠ½å±‰å¯¼èˆªï¼ˆå®ä¾‹åˆ—è¡¨ï¼‰
- å³ä¾§å†…å®¹åŒºåŸŸï¼ˆåŠ¨æ€è·¯ç”±è§†å›¾ï¼‰
- é¡¶éƒ¨å·¥å…·æ ï¼ˆå¯åŠ¨/åœæ­¢æŒ‰é’®ï¼‰

**HomePage** (`pages/HomePage.vue`):

- æ˜¾ç¤ºæ‰€æœ‰å®ä¾‹å¡ç‰‡
- å¿«é€Ÿæ“ä½œæŒ‰é’®ï¼ˆå¯åŠ¨ã€æ›´æ–°ã€åˆ é™¤ï¼‰
- æ— å®ä¾‹æ—¶è·³è½¬åˆ° WelcomePage

**InstancePage** (`pages/InstancePage.vue`):

- åŠ¨æ€è·¯ç”±: `/instance/:name/:tab`
- Tab é¡µç­¾: General, Update, Custom
- é…ç½®è¡¨å•ï¼ˆæ ¹æ®æ¨¡æ¿åŠ¨æ€ç”Ÿæˆï¼‰
- å®æ—¶æ—¥å¿—æŸ¥çœ‹å™¨

**SettingsPage** (`pages/SettingsPage.vue`):

- åº”ç”¨è®¾ç½®ï¼ˆè¯­è¨€ã€ä¸»é¢˜ã€è‡ªåŠ¨æ›´æ–°ï¼‰
- å…³æœºé€‰é¡¹è®¾ç½®

---

## 5. å…³é”®ä¸šåŠ¡æµç¨‹

### 5.1 åº”ç”¨å¯åŠ¨æµç¨‹

```
1. main.go å¯åŠ¨
   â”œâ”€ InitLogger() - åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
   â”œâ”€ InitDB() - åˆå§‹åŒ– SQLite æ•°æ®åº“
   â”œâ”€ SetupRouter() - é…ç½® Gin è·¯ç”±
   â”œâ”€ go r.Run(":48596") - å¯åŠ¨ HTTP æœåŠ¡å™¨ï¼ˆåå°ï¼‰
   â””â”€ wails.Run() - å¯åŠ¨ Wails æ¡Œé¢åº”ç”¨

2. Wails App.Startup()
   â”œâ”€ æ£€æŸ¥å¹¶åˆ›å»ºé…ç½®æ–‡ä»¶ç¬¦å·é“¾æ¥
   â”œâ”€ å¯åŠ¨æ–‡ä»¶ç›‘æ§å™¨ï¼ˆç›‘å¬å®ä¾‹é…ç½®å˜åŒ–ï¼‰
   â”œâ”€ åŠ è½½å…¨å±€è®¾ç½®
   â”œâ”€ ä¸ºæ¯ä¸ªå®ä¾‹è®¾ç½® Cron å®šæ—¶ä»»åŠ¡
   â””â”€ åˆ é™¤æ—§ç‰ˆæœ¬å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

3. å‰ç«¯å¯åŠ¨
   â”œâ”€ Quasar åˆå§‹åŒ–
   â”œâ”€ Axios é…ç½®ï¼ˆbaseURL: http://localhost:48596ï¼‰
   â”œâ”€ i18n åŠ è½½
   â”œâ”€ Pinia Store åˆå§‹åŒ–
   â”œâ”€ fetchInstances() - è·å–æ‰€æœ‰å®ä¾‹
   â”œâ”€ fetchTemplates() - è·å–æ‰€æœ‰æ¨¡æ¿
   â””â”€ connectWebSocket() - å»ºç«‹ WebSocket è¿æ¥
```

### 5.2 åˆ›å»ºå®ä¾‹æµç¨‹

#### 5.2.1 ä»è¿œç¨‹ Git åˆ›å»º

```
1. ç”¨æˆ·åœ¨å‰ç«¯å¡«å†™è¡¨å•
   - Git URL: https://github.com/user/repo
   - Branch: main (å¯é€‰)
   - Instance Name: my-instance

2. å‰ç«¯å‘é€ POST /api/instance/remote
   {
     "repo_url": "https://github.com/user/repo",
     "branch": "main",
     "instance_name": "my-instance"
   }

3. åç«¯å¤„ç† (InstanceService.ImportTemplate)
   â”œâ”€ GitClone(url, "repos/", branch) - å…‹éš†ä»“åº“åˆ° repos/ ç›®å½•
   â”‚   â””â”€ æŸ¥æ‰¾ Git å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆç³»ç»Ÿ/bundled/è‡ªåŠ¨ä¸‹è½½ï¼‰
   â”œâ”€ è§£æ template/template.yaml - è¯»å–æ¨¡æ¿é…ç½®
   â”œâ”€ ä¿å­˜åˆ°æ•°æ®åº“ (TemplateInfo è¡¨)
   â”œâ”€ åˆ›å»ºå®ä¾‹ (InstanceInfo è¡¨)
   â”‚   â”œâ”€ è®¾ç½®é»˜è®¤å€¼ï¼ˆä»æ¨¡æ¿ï¼‰
   â”‚   â”œâ”€ åˆ›å»ºç¬¦å·é“¾æ¥: instances/my-instance.json -> repos/.../config.json
   â”‚   â””â”€ è§£æä»»åŠ¡åˆ—è¡¨å¹¶ä¿å­˜ (TaskInfo è¡¨)
   â”œâ”€ åˆ›å»º TaskManager å¹¶æ·»åŠ åˆ° Scheduler
   â””â”€ è¿”å›å®ä¾‹ä¿¡æ¯ç»™å‰ç«¯

4. å‰ç«¯æ›´æ–°
   â”œâ”€ Store.instances.push(newInstance)
   â”œâ”€ è·³è½¬åˆ°å®ä¾‹è¯¦æƒ…é¡µ
   â””â”€ WebSocket æ¨é€åˆå§‹çŠ¶æ€
```

#### 5.2.2 ä»æ¨¡æ¿åˆ›å»º

```
1. ç”¨æˆ·é€‰æ‹©å·²æœ‰æ¨¡æ¿
2. å‰ç«¯å‘é€ POST /api/instance/template
3. åç«¯ç›´æ¥ä» TemplateInfo å¤åˆ¶é…ç½®åˆ›å»ºå®ä¾‹
4. æ— éœ€å†æ¬¡å…‹éš†ä»“åº“
```

### 5.3 ä»»åŠ¡æ‰§è¡Œæµç¨‹

#### 5.3.1 å¯åŠ¨å•ä¸ªå®ä¾‹

```
1. ç”¨æˆ·ç‚¹å‡»"å¯åŠ¨"æŒ‰é’®ï¼ˆHomePage æˆ– InstancePageï¼‰

2. å‰ç«¯å‘é€ POST /api/scheduler
   {
     "action_type": "start",
     "instance_name": "my-instance"
   }

3. åç«¯ SchedulerController
   â”œâ”€ SchedulerService.UpdateSchedulerState("start", "my-instance")
   â””â”€ go SchedulerService.StartOne("my-instance")

4. SchedulerService.StartOne()
   â”œâ”€ æ›´æ–°çŠ¶æ€: StatusPending â†’ StatusRunning
   â”œâ”€ WebSocket å¹¿æ’­çŠ¶æ€å˜åŒ–
   â”œâ”€ å¾ªç¯æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—
   â”‚   â”œâ”€ taskName = tm.SwitchRun() - ä» Waiting å–å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡
   â”‚   â”œâ”€ WebSocket å¹¿æ’­é˜Ÿåˆ—æ›´æ–°
   â”‚   â”œâ”€ è·å–ä»»åŠ¡ä¿¡æ¯ (TaskInfo)
   â”‚   â”œâ”€ æ„å»ºå‘½ä»¤
   â”‚   â”‚   â””â”€ å¦‚æœæ˜¯ "py xxx.py"ï¼Œæ›¿æ¢ä¸ºè™šæ‹Ÿç¯å¢ƒçš„ python.exe
   â”‚   â”œâ”€ RunCommand(tm, cmd, workDir)
   â”‚   â”‚   â”œâ”€ åˆ›å»º exec.Command
   â”‚   â”‚   â”œâ”€ è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆPYTHONUNBUFFERED, FORCE_COLORï¼‰
   â”‚   â”‚   â”œâ”€ åˆ›å»º stdout/stderr pipe
   â”‚   â”‚   â”œâ”€ cmd.Start() - å¯åŠ¨è¿›ç¨‹
   â”‚   â”‚   â”œâ”€ processOutput() - è¯»å–è¾“å‡ºå¹¶å®æ—¶æ¨é€
   â”‚   â”‚   â”‚   â”œâ”€ æ£€æµ‹ç¼–ç ï¼ˆUTF-8/GBKï¼‰
   â”‚   â”‚   â”‚   â””â”€ WebSocket.BroadcastLog()
   â”‚   â”‚   â””â”€ cmd.Wait() - ç­‰å¾…è¿›ç¨‹ç»“æŸ
   â”‚   â””â”€ æ£€æŸ¥é”™è¯¯
   â”‚       â”œâ”€ æˆåŠŸ: ç»§ç»­ä¸‹ä¸€ä¸ªä»»åŠ¡
   â”‚       â”œâ”€ å¤±è´¥: åœæ­¢å¹¶è®¾ç½® StatusFailed
   â”‚       â””â”€ æ‰‹åŠ¨åœæ­¢: è¿”å›
   â””â”€ æ‰€æœ‰ä»»åŠ¡å®Œæˆ: StatusRunning â†’ StatusPending

5. å‰ç«¯å®æ—¶æ›´æ–°
   â”œâ”€ ç›‘å¬ WebSocket æ¶ˆæ¯
   â”œâ”€ type="state" â†’ æ›´æ–°å®ä¾‹çŠ¶æ€ï¼ˆé¢œè‰²ã€å›¾æ ‡ï¼‰
   â”œâ”€ type="queue" â†’ æ›´æ–°ä»»åŠ¡åˆ—è¡¨ï¼ˆRunning/Waiting/Stoppedï¼‰
   â””â”€ type="log" â†’ è¿½åŠ æ—¥å¿—åˆ° LogViewer
```

#### 5.3.2 å¯åŠ¨å…¨éƒ¨å®ä¾‹

```
1. ç”¨æˆ·ç‚¹å‡»"å…¨éƒ¨å¯åŠ¨"æŒ‰é’®

2. SchedulerService.StartAll()
   â”œâ”€ Scheduler.Start() - è®¾ç½® IsRunning=true
   â”œâ”€ WebSocket å¹¿æ’­å…¨å±€çŠ¶æ€ â†’ Running
   â”œâ”€ è·å–æ‰€æœ‰ Ready çš„å®ä¾‹
   â”œâ”€ åˆ†ç±»: Background vs Foreground
   â”‚   â”œâ”€ Background: å¹¶å‘æ‰§è¡Œï¼ˆå¤šä¸ª goroutineï¼‰
   â”‚   â””â”€ Foreground: é¡ºåºæ‰§è¡Œï¼ˆç­‰å¾…ä¸Šä¸€ä¸ªå®Œæˆï¼‰
   â”œâ”€ runBackgroundTasks(backgroundList)
   â”‚   â””â”€ ä¸ºæ¯ä¸ªå®ä¾‹å¯åŠ¨ goroutine
   â”‚       â””â”€ runWithCheck() â†’ StartOne()
   â”œâ”€ runForegroundTasks(foregroundList)
   â”‚   â””â”€ éå†åˆ—è¡¨ï¼Œé€ä¸ªæ‰§è¡Œ
   â”‚       â”œâ”€ è·³è¿‡ StatusUpdating çš„å®ä¾‹ï¼ˆé‡æ–°æ’é˜Ÿï¼‰
   â”‚       â””â”€ StartOne()
   â””â”€ ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
       â”œâ”€ Scheduler.Stop()
       â”œâ”€ TriggerCloseFunc() - å¯èƒ½å…³æœº
       â””â”€ WebSocket å¹¿æ’­å…¨å±€çŠ¶æ€ â†’ Pending
```

### 5.4 å®ä¾‹æ›´æ–°æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"æ›´æ–°"æŒ‰é’®æˆ–è‡ªåŠ¨è§¦å‘

2. å‰ç«¯å‘é€ POST /api/update/instance/:name

3. InstanceUpdaterService.UpdateRepo()
   â”œâ”€ è®¾ç½®çŠ¶æ€: StatusPending â†’ StatusUpdating
   â”œâ”€ WebSocket å¹¿æ’­çŠ¶æ€
   â”œâ”€ ç§»é™¤é…ç½®æ–‡ä»¶ç¬¦å·é“¾æ¥
   â”œâ”€ GitPull(localPath) - æ‹‰å–æœ€æ–°ä»£ç 
   â”‚   â”œâ”€ git fetch origin
   â”‚   â”œâ”€ git pull origin
   â”‚   â”œâ”€ å¦‚æœæœ‰å†²çª:
   â”‚   â”‚   â”œâ”€ git merge --abort
   â”‚   â”‚   â””â”€ git reset --hard @{u}
   â”‚   â””â”€ è¿”å›å‘½ä»¤æ—¥å¿—
   â”œâ”€ é‡æ–°åˆ›å»ºç¬¦å·é“¾æ¥
   â”œâ”€ å¦‚æœé…ç½®äº†è™šæ‹Ÿç¯å¢ƒ:
   â”‚   â”œâ”€ createEnv() - åˆ›å»º/æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ
   â”‚   â”‚   â””â”€ uv venv --python 3.13 envs/my-env
   â”‚   â”œâ”€ installDeps() - å®‰è£…ä¾èµ–
   â”‚   â”‚   â”œâ”€ å¯¹æ¯” requirements.txt ä¿®æ”¹æ—¶é—´
   â”‚   â”‚   â””â”€ uv pip install -r requirements.txt
   â”‚   â””â”€ æ›´æ–° EnvLastUpdate æ—¶é—´æˆ³
   â”œâ”€ æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ˜¯å¦æ›´æ–°
   â”‚   â”œâ”€ å¯¹æ¯” LayoutLastUpdate å’Œæ–‡ä»¶ä¿®æ”¹æ—¶é—´
   â”‚   â”œâ”€ å¦‚æœæ›´æ–°: é‡æ–°è§£æ template.yaml
   â”‚   â””â”€ æ›´æ–°æ•°æ®åº“ä¸­çš„å®ä¾‹é…ç½®
   â””â”€ æ¢å¤çŠ¶æ€: StatusUpdating â†’ Pending/Failed

4. å‰ç«¯æ›´æ–°
   â”œâ”€ å®ä¾‹çŠ¶æ€å›¾æ ‡å˜åŒ–
   â””â”€ å¦‚æœå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
```

### 5.5 é…ç½®æ–‡ä»¶ç³»ç»Ÿ

#### 5.5.1 æ¨¡æ¿é…ç½® (template.yaml)

```yaml
# æ¨¡æ¿å…ƒä¿¡æ¯
name: "my-template"
version: "1.0.0"
author: "username"

# é…ç½®é¡¹å®šä¹‰
config:
  general:
    - name: "work_dir"
      type: "dir"
      label: "å·¥ä½œç›®å½•"
      default: "./"
      disabled: false
    - name: "language"
      type: "dropdown"
      label: "è¯­è¨€"
      options: ["zh-CN", "en-US"]
      default: "zh-CN"

  custom:
    - name: "api_key"
      type: "input"
      label: "API Key"
      default: ""

# ä»»åŠ¡å®šä¹‰
tasks:
  - name: "task1"
    command: "py script.py"
    priority: 1
    active: true
  - name: "task2"
    command: "py another.py"
    priority: 2
```

#### 5.5.2 å®ä¾‹é…ç½® (instances/xxx.json)

```json
{
  "work_dir": "./repos/my-repo",
  "language": "zh-CN",
  "api_key": "your-api-key",
  "tasks": [
    {
      "name": "task1",
      "active": true,
      "priority": 1
    }
  ]
}
```

#### 5.5.3 é…ç½®æµè½¬

```
1. template.yaml å®šä¹‰é…ç½®ç»“æ„
   â””â”€ åç«¯è§£æä¸º TemplateInfo

2. ç”¨æˆ·åœ¨å‰ç«¯ä¿®æ”¹é…ç½®
   â””â”€ ä¿å­˜åˆ° InstanceInfo æ•°æ®åº“

3. ç¬¦å·é“¾æ¥è¿æ¥åˆ°ä»“åº“
   instances/xxx.json â†’ repos/my-repo/config.json

4. è„šæœ¬è¯»å– config.json è·å–ç”¨æˆ·é…ç½®
```

### 5.6 WebSocket å®æ—¶é€šä¿¡

#### 5.6.1 è¿æ¥å»ºç«‹

```
å‰ç«¯: new WebSocket("ws://localhost:48596/ws")
åç«¯: HandleConnection() - æ³¨å†Œåˆ° WSManager
```

#### 5.6.2 æ¶ˆæ¯æµå‘

```
åç«¯äº‹ä»¶ â†’ WebSocketService.Broadcast*() â†’ WSManager.BroadcastJSON()
                                           â†“
                                    éå†æ‰€æœ‰è¿æ¥
                                           â†“
                                    conn.WriteJSON()
                                           â†“
                                    å‰ç«¯ ws.onmessage
                                           â†“
                                    æ›´æ–° Pinia Store
                                           â†“
                                    Vue å“åº”å¼æ›´æ–°ç•Œé¢
```

#### 5.6.3 æ–­çº¿é‡è¿

```
å‰ç«¯æ£€æµ‹ ws.onclose â†’ 3 ç§’åé‡æ–°è¿æ¥ â†’ é‡æ–°è·å–åˆå§‹çŠ¶æ€
```
